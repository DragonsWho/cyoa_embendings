============================================================
PROJECT STRUCTURE:
./
    manage.py
    process_static_cyoa.py
    TODO.md
    config.py
    todo
    !collect_project.py
    create_database.py
    upload_data.sh
    indexer.py
    clear_database.py
    reset_index_status.py
    requirements.txt
    summary_prompt.txt
    generate_summary.py
    main.py
    sync_with_pocketbase.py
    .gitignore
    readme
    fetch_game_text.py
    static/
        style.css
        index.html
        script.js
    thrash/
        111_summarize_project.py
        111_project_summary.txt
============================================================



============================================================
FILE PATH: ./manage.py
============================================================
# manage.py
import os
import subprocess
import sys

# --- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ ---
from sync_with_pocketbase import sync_games
from fetch_game_text import main as fetch_texts
from generate_summary import run_summary_generation
from indexer import main as run_indexer
from clear_database import clear_all_games
from reset_index_status import reset_all_statuses


def print_menu():
    """–í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Å–∏–≤–æ–µ –º–µ–Ω—é –≤ –∫–æ–Ω—Å–æ–ª—å."""
    print("\n" + "="*40)
    print("     –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ CYOA     ")
    print("="*40)
    print("\n--- –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞–π–ø–ª–∞–π–Ω ---")
    print(" 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—ã —Å PocketBase")
    print(" 2. –ò–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –∏–≥—Ä (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö)")
    print(" 3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è (summaries) –¥–ª—è –∏–≥—Ä —Å —Ç–µ–∫—Å—Ç–æ–º")
    print(" 4. –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ù–û–í–´–ï –∏–≥—Ä—ã (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)")
    print(" 4a. [–î–û–õ–ì–û] –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –í–°–ï –∏–≥—Ä—ã")
    print(" 5. [–í–°–Å –°–†–ê–ó–£] –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω (—à–∞–≥–∏ 1-4)")
    
    print("\n--- –í–µ–±-—Å–µ—Ä–≤–µ—Ä ---")
    print(" 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä API (FastAPI)")

    print("\n--- –£—Ç–∏–ª–∏—Ç—ã –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ---")
    print(" 7. –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä")
    print(" 8. [–û–ü–ê–°–ù–û] –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–≥—Ä—ã)")

    print("\n 0. –í—ã—Ö–æ–¥")
    print("-"*40)


def run_server():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç FastAPI —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é uvicorn."""
    print("\n--- –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ FastAPI ---")
    print("–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://127.0.0.1:8000")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ CTRL+C.")
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º subprocess –¥–ª—è –∑–∞–ø—É—Å–∫–∞ uvicorn, —á—Ç–æ–±—ã –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª
        # –≤ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É.
        subprocess.run([sys.executable, "-m", "uvicorn", "main:app", "--reload"])
    except KeyboardInterrupt:
        print("\n–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    except FileNotFoundError:
        print("\n[–û–®–ò–ë–ö–ê] –ö–æ–º–∞–Ω–¥–∞ 'uvicorn' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ uvicorn —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: pip install uvicorn")


def main():
    """–ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    while True:
        print_menu()
        choice = input("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è: ")

        if choice == '1':
            sync_games()
        elif choice == '2':
            fetch_texts()
        elif choice == '3':
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            run_summary_generation()
        elif choice == '4':
            # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            run_indexer(full_reindex=False)
        elif choice == '4a':
            # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
            print("\n--- –ó–∞–ø—É—Å–∫ –ü–û–õ–ù–û–ô –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ ---")
            run_indexer(full_reindex=True)
        elif choice == '5':
            print("\n--- –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ---")
            sync_games()
            print("\n--- –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ---")
            fetch_texts()
            print("\n--- –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π ---")
            run_summary_generation()
            print("\n--- –§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥: –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ---")
            run_indexer(full_reindex=False)
            print("\n--- –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–µ–Ω! ---")
        elif choice == '6':
            run_server()
        elif choice == '7':
            reset_all_statuses()
        elif choice == '8':
            clear_all_games()
        elif choice == '0':
            print("–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã.")
            break
        else:
            print("\n[!] –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–∑ –º–µ–Ω—é.")
        
        input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...")


if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    required_files = [
        'sync_with_pocketbase.py', 'fetch_game_text.py', 'generate_summary.py',
        'indexer.py', 'main.py', 'clear_database.py', 'reset_index_status.py'
    ]
    missing_files = [f for f in required_files if not os.path.exists(f)]
    if missing_files:
        print("[–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê] –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã —Å–∫—Ä–∏–ø—Ç–æ–≤:")
        for f in missing_files:
            print(f" - {f}")
        sys.exit(1)

    main()

============================================================
FILE PATH: ./process_static_cyoa.py
============================================================
# process_static_cyoa.py


import logging
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫ Google –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
logging.getLogger('google.api_core').setLevel(logging.WARNING)
logging.getLogger('google.auth').setLevel(logging.WARNING)
logging.getLogger('google.cloud').setLevel(logging.WARNING)
import os
import sqlite3
import json
import requests # –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
from datetime import datetime
from dotenv import load_dotenv
from google.cloud import vision




# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
DB_FILE = "games.db"

def recognize_text_from_content(image_content: bytes):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–∏–Ω–∞—Ä–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Google Cloud Vision API
    –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    try:
        client = vision.ImageAnnotatorClient()
        image = vision.Image(content=image_content)
        
        response = client.document_text_detection(image=image)

        if response.error.message:
            raise Exception(f"–û—à–∏–±–∫–∞ API: {response.error.message}")

        return response.full_text_annotation.text if response.full_text_annotation else ""
    
    except Exception as e:
        print(f"  [!] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏: {e}")
        return None


def process_static_games():
    """
    –ù–∞—Ö–æ–¥–∏—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—á–Ω—ã–µ CYOA –≤ –±–∞–∑–µ, —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ç–µ–∫—Å—Ç 
    —Å –∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA...")
    conn = sqlite3.connect(DB_FILE)
    # –£–¥–æ–±–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä–µ–π
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # –í—ã–±–∏—Ä–∞–µ–º –∏–≥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∏ —è–≤–ª—è—é—Ç—Å—è —Å—Ç–∞—Ç–∏—á–Ω—ã–º–∏ (–∏–º–µ—é—Ç image_urls)
    cursor.execute("""
        SELECT pocketbase_id, title, image_urls FROM games
        WHERE is_indexed = 0 AND image_urls IS NOT NULL AND image_urls != '[]'
    """)
    games_to_process = cursor.fetchall()

    if not games_to_process:
        print("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
        conn.close()
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(games_to_process)} —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.")

    for game in games_to_process:
        print(f"\n--- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: '{game['title']}' (ID: {game['pocketbase_id']}) ---")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ URL –∏–∑ JSON-—Å—Ç—Ä–æ–∫–∏
        image_urls = json.loads(game['image_urls'])
        all_pages_text = []

        for i, url in enumerate(image_urls, 1):
            print(f"  > –°–∫–∞—á–∏–≤–∞–µ–º –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É {i}/{len(image_urls)}...")
            
            try:
                # –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
                response = requests.get(url, timeout=30)
                response.raise_for_status() # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω (–∫–æ–¥ 2xx)
                image_bytes = response.content

                # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ç–µ–∫—Å—Ç
                recognized_text = recognize_text_from_content(image_bytes)
                if recognized_text:
                    all_pages_text.append(recognized_text)

            except requests.exceptions.RequestException as e:
                print(f"  [!] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ URL: {url}. –û—à–∏–±–∫–∞: {e}")
                continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        
        if all_pages_text:
            # –°–æ–µ–¥–∏–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
            full_text = "\n\n--- PAGE BREAK ---\n\n".join(all_pages_text)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            current_time_iso = datetime.now().isoformat()
            cursor.execute("""
                UPDATE games
                SET full_text = ?, is_indexed = 1, last_indexed_at = ?
                WHERE pocketbase_id = ?
            """, (full_text, current_time_iso, game['pocketbase_id']))
            conn.commit()
            print(f"  [OK] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è '{game['title']}'.")
        else:
            print(f"  [!] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∏ –Ω–∞ –æ–¥–Ω–æ–π –∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è '{game['title']}'.")

    conn.close()
    print("\n–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


if __name__ == "__main__":
    process_static_games()

============================================================
FILE PATH: ./TODO.md
============================================================
# –ü–ª–∞–Ω –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞ CYOA Embeddings

 

## 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 2.1. –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤

-   **–ü—Ä–æ–±–ª–µ–º–∞:** `fetch_game_text.py` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–≥—Ä—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. –ó–∞–≥—Ä—É–∑–∫–∞ `project.json` ‚Äî —ç—Ç–æ I/O-–æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏—é.
-   **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `concurrent.futures.ThreadPoolExecutor` –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ `project.json` –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–≥—Ä. –ó–∞–ø—É—Å–∫ Selenium –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –∏–≥—Ä, –≥–¥–µ –ø—Ä—è–º–æ–π –º–µ—Ç–æ–¥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª.

### 2.2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

-   **–ü—Ä–æ–±–ª–µ–º–∞:** `indexer.py` –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤—Å–µ—Ö –∏–≥—Ä. –≠—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∏–≥—Ä–∞.
-   **–†–µ—à–µ–Ω–∏–µ:** –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `indexer.py` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:
    1.  –î–æ–±–∞–≤–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç `--incremental` –∏–ª–∏ `--since <timestamp>`.
    2.  –í—ã–±–∏—Ä–∞—Ç—å –∏–∑ –ë–î —Ç–æ–ª—å–∫–æ —Ç–µ –∏–≥—Ä—ã, –≥–¥–µ `last_indexed_at` IS NULL (–Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ).
    3.  –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Faiss-–∏–Ω–¥–µ–∫—Å –∏ –∫–∞—Ä—Ç—É —á–∞–Ω–∫–æ–≤.
    4.  –£–¥–∞–ª—è—Ç—å –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ —Å—Ç–∞—Ä—ã–µ –≤–µ–∫—Ç–æ—Ä—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º –∏–≥—Ä–∞–º (–ø–æ `game_id`). –≠—Ç–æ —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å, —Ç—Ä–µ–±—É—é—â–∞—è `index.remove_ids()`.
    5.  –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–∏—Ö –∏–≥—Ä.
    *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ, –ø–æ—ç—Ç–æ–º—É —ç—Ç—É –∑–∞–¥–∞—á—É —Å—Ç–æ–∏—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π.*

## 3. –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 3.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `main.py` –≤–∫–ª—é—á–∞–µ—Ç—Å—è/–≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `DEBUG_LOGGING`. –õ–æ–≥–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö –≤—ã–≤–æ–¥—è—Ç—Å—è —á–µ—Ä–µ–∑ `print()` –∏–ª–∏ `tqdm.write()`.
-   **–†–µ—à–µ–Ω–∏–µ:** –í–Ω–µ–¥—Ä–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `logging` –≤–æ –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (INFO, WARNING, ERROR) –∏ –≤—ã–≤–æ–¥–∏—Ç—å –∏—Ö –≤ –∫–æ–Ω—Å–æ–ª—å –∏/–∏–ª–∏ —Ñ–∞–π–ª. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤—ã–≤–æ–¥–∞.

### 3.2. –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ API

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –í `generate_summary.py` –æ—à–∏–±–∫–∞ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ `"API_ERROR: ..."`. –≠—Ç–æ –Ω–µ –æ—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±.
-   **–†–µ—à–µ–Ω–∏–µ:** –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `generate_summary_with_openrouter` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–ª–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (raise Exception) –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏. –í –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ `process_game` –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤—ã–∑–æ–≤ –≤ `try...except` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ—Ä—Ç–µ–∂ `(pb_id, title, None, error_message)`. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –±–æ–ª–µ–µ —è–≤–Ω–æ–π.

## 4. –£–ª—É—á—à–µ–Ω–∏—è Frontend

### 4.1. –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ –±–∞–∑–µ –±—É–¥—É—Ç —Ç—ã—Å—è—á–∏ –∏–≥—Ä, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "All Games" —Å—Ç–∞–Ω–µ—Ç –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–π –∏ –≥—Ä–æ–º–æ–∑–¥–∫–æ–π, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ –∏–≥—Ä—ã —Å—Ä–∞–∑—É.
-   **–†–µ—à–µ–Ω–∏–µ:**
    1.  –ù–∞ –±—ç–∫–µ–Ω–¥–µ (`main.py` –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ `/games`) –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `page` –∏ `page_size` –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
    2.  –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (`static/script.js`) —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å "–±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É" (infinite scroll) –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ", –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Ä—Ü–∏—é –∏–≥—Ä –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

### 4.2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å.
-   **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª–µ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞ —Ç–∞–∫–∂–µ —Ñ–∏–ª—å—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¢–æ–ª—å–∫–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º", "–ù–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ") –∏ –æ–ø—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É, –ø–æ –¥–∞—Ç–µ). –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥.

---


============================================================
FILE PATH: ./config.py
============================================================
# config.py

"""
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.
–í—Å–µ –æ–±—â–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∑–¥–µ—Å—å.
"""

# --- –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º ---
DB_FILE = "games.db"
INDEX_FILE = "games.index"
MAPPING_FILE = "chunk_map.json"
SUMMARY_PROMPT_FILE = "summary_prompt.txt"

# --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ---
DEBUG_LOGGING = False # –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ main.py
LOG_FILE = "search_debug.log"
QUERY_LOG_FILE = "user_queries.jsonl"

# --- –ú–æ–¥–µ–ª–∏ ---
EMBEDDING_MODEL_NAME = "gemini-embedding-001"
GENERATION_MODEL_NAME = "deepseek/deepseek-v3.2-exp"

# --- API –∏ –°–µ—Ä–≤–∏—Å—ã ---
BASE_GAME_URL = "https://cyoa.cafe/game/"

# --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ ---
OUTPUT_DIMENSION = 256
BATCH_SIZE = 100
API_REQUEST_DELAY = 3 # –ü–∞—É–∑–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –º–µ–∂–¥—É API –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ indexer.py
MAX_RETRIES = 3

# --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –≤ main.py ---
SUMMARY_WEIGHT = 0.70 
TEXT_WEIGHT = 0.30    
DECAY_FACTOR = 0.85 

============================================================
FILE PATH: ./!collect_project.py
============================================================
import os

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
OUTPUT_FILE = "FULL_PROJECT_DUMP.txt"

# –ü–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ü–û–õ–ù–û–°–¢–¨–Æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
IGNORE_DIRS = {
    'venv', 
    '__pycache__', 
    '.git', 
    '.idea', 
    '.vscode',
    'OTHER',                 # –ü–∞–ø–∫–∞ —Å –º—É—Å–æ—Ä–æ–º
    'semantic-search-deploy' # –°—Ç–∞—Ä–∞—è –ø–∞–ø–∫–∞ –¥–µ–ø–ª–æ—è
}

# –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ç–æ—á–Ω–æ –ù–ï —á–∏—Ç–∞–µ–º (—Å–µ–∫—Ä–µ—Ç—ã, –±–∞–∑—ã, –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ)
IGNORE_FILES = {
    '.env',                  # –°–ï–ö–†–ï–¢–´
    'gcp-credentials.json',  # –°–ï–ö–†–ï–¢–´
    'games.db',              # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    'games.index',           # –ò–Ω–¥–µ–∫—Å Faiss (–±–∏–Ω–∞—Ä–Ω—ã–π)
    'chunk_map.json',        # –ö–∞—Ä—Ç–∞ —á–∞–Ω–∫–æ–≤ (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è)
    'search_debug.log',      # –õ–æ–≥–∏
    'user_queries.jsonl',    # –õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
    OUTPUT_FILE,             # –°–∞–º —ç—Ç–æ—Ç —Ñ–∞–π–ª
    'collect_project.py',    # –°–∞–º —Å–∫—Ä–∏–ø—Ç
    '.DS_Store'
}

# –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Ö–æ—Ç–∏–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å (–∫–æ–¥ –∏ —Ç–µ–∫—Å—Ç)
ALLOWED_EXTENSIONS = {
    '.py', '.txt', '.md', '.sh', 
    '.html', '.css', '.js', 
    '.json', '.xml', '.yaml', '.yml'
}

def is_ignored(path, names):
    """–§–∏–ª—å—Ç—Ä –¥–ª—è os.walk, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–∞–ø–∫–∏"""
    return {n for n in names if n in IGNORE_DIRS}

def generate_tree(startpath):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞"""
    tree_str = "PROJECT STRUCTURE:\n"
    for root, dirs, files in os.walk(startpath):
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∞–ø–æ–∫ "–Ω–∞ –ª–µ—Ç—É"
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        level = root.replace(startpath, '').count(os.sep)
        indent = ' ' * 4 * (level)
        tree_str += f"{indent}{os.path.basename(root)}/\n"
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if f not in IGNORE_FILES:
                tree_str += f"{subindent}{f}\n"
    return tree_str

def main():
    print(f"Start collecting project files into {OUTPUT_FILE}...")
    
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as outfile:
        # 1. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
        outfile.write("="*60 + "\n")
        outfile.write(generate_tree("."))
        outfile.write("="*60 + "\n\n")

        # 2. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ —Ñ–∞–π–ª–∞–º –∏ —á–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        for root, dirs, files in os.walk("."):
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∞–ø–æ–∫
            dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]

            for file in files:
                if file in IGNORE_FILES:
                    continue
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
                _, ext = os.path.splitext(file)
                if ext.lower() not in ALLOWED_EXTENSIONS:
                    continue

                file_path = os.path.join(root, file)
                
                # –ö—Ä–∞—Å–∏–≤—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                outfile.write(f"\n\n{'='*60}\n")
                outfile.write(f"FILE PATH: {file_path}\n")
                outfile.write(f"{'='*60}\n")

                try:
                    with open(file_path, 'r', encoding='utf-8', errors='replace') as infile:
                        content = infile.read()
                        outfile.write(content)
                except Exception as e:
                    outfile.write(f"\n[ERROR READING FILE: {e}]\n")

    print(f"Done! File saved as: {OUTPUT_FILE}")
    print("‚ö†Ô∏è  PLEASE CHECK THE FILE BEFORE SENDING TO ENSURE NO SECRETS ARE INSIDE! ‚ö†Ô∏è")

if __name__ == "__main__":
    main()

============================================================
FILE PATH: ./create_database.py
============================================================
# create_database.py
import sqlite3
import os

DB_FILE = "games.db"

def create_database():
    """–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∞–±–ª–∏—Ü—É 'games' —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π."""
    if os.path.exists(DB_FILE):
        print(f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{DB_FILE}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        print("–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É, —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é.")
        return

    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        cursor.execute('''
        CREATE TABLE games (
            pocketbase_id TEXT PRIMARY KEY,
            title TEXT NOT NULL,
            original_url TEXT, -- –î–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö CYOA (iframe_url)
            image_urls TEXT,   -- –ù–û–í–û–ï –ü–û–õ–ï: –¥–ª—è JSON-—Å–ø–∏—Å–∫–∞ URL-–æ–≤ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA
            full_text TEXT,
            summary TEXT,
            source_hash TEXT,
            last_indexed_at TIMESTAMP,
            is_indexed BOOLEAN DEFAULT 0
        )
        ''')

        conn.commit()
        conn.close()
        print(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö '{DB_FILE}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ —Å –∫–æ–ª–æ–Ω–∫–æ–π 'image_urls'.")

    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")

if __name__ == "__main__":
    # –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤, —É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π games.db
    # –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.
    create_database()

============================================================
FILE PATH: ./upload_data.sh
============================================================
#!/bin/bash

# ==============================================================================
#      –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# ==============================================================================

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ê–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
SERVER="root@165.227.118.100"
# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å / –≤ –∫–æ–Ω—Ü–µ)
REMOTE_DIR="/root/semantic-search/"
# –°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
SERVICE_NAME="semantic-search.service"
# –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å
FILES_TO_UPLOAD=(
    "games.db"
    "games.index"
    "chunk_map.json"
)
# -----------------

echo ">>> –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–æ–∫–∞–ª—å–Ω–æ
echo "1/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
for file in "${FILES_TO_UPLOAD[@]}"; do
    if [ ! -f "$file" ]; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª '$file' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞."
        exit 1
    fi
done
echo "‚úÖ –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ."

# 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª—ã
echo "2/5: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–µ—Ä–≤–∏—Å '$SERVICE_NAME' –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh $SERVER "systemctl stop $SERVICE_NAME"
echo "‚úÖ –°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

# 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é scp
echo "3/5: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
for file in "${FILES_TO_UPLOAD[@]}"; do
    echo "    -> –ó–∞–≥—Ä—É–∂–∞—é $file..."
    # scp [–ª–æ–∫–∞–ª—å–Ω—ã–π_—Ñ–∞–π–ª] [–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@—Å–µ—Ä–≤–µ—Ä:—É–¥–∞–ª–µ–Ω–Ω—ã–π_–ø—É—Ç—å]
    scp -q "$file" "${SERVER}:${REMOTE_DIR}"
done
echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã."

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo "4/5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å '$SERVICE_NAME'..."
ssh $SERVER "systemctl restart $SERVICE_NAME"
echo "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞."

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
echo "5/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥)..."
sleep 3 # –î–∞–µ–º —Å–µ—Ä–≤–∏—Å—É –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—É—Å–∫
ssh $SERVER "systemctl status $SERVICE_NAME --no-pager | tail -n 10"

echo ""
echo "üéâ –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "–ü—Ä–æ–≤–µ—Ä—å –≤—ã–≤–æ–¥ –≤—ã—à–µ: —Å—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'active (running)' (–∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º)."

============================================================
FILE PATH: ./indexer.py
============================================================
# indexer.py (–í–µ—Ä—Å–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Summary –∏ –ø–∞—É–∑–æ–π –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)
import json
import os
import numpy as np
import faiss
import google.generativeai as genai
import argparse
import sqlite3
import time
from dotenv import load_dotenv
from tqdm import tqdm
from datetime import datetime
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
if not GOOGLE_API_KEY:
    raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω GOOGLE_API_KEY –≤ .env —Ñ–∞–π–ª–µ")
genai.configure(api_key=GOOGLE_API_KEY)

def chunk_raw_text(text, chunk_size=500, overlap=50):
    """–†–∞–∑–±–∏–≤–∞–µ—Ç —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –∏–≥—Ä—ã –Ω–∞ —á–∞–Ω–∫–∏."""
    words = text.split()
    if not words: return []
    chunks = []
    start = 0
    while start < len(words):
        end = start + chunk_size
        chunk_words = words[start:end]
        chunks.append(" ".join(chunk_words))
        if end >= len(words): break
        start += chunk_size - overlap
    return chunks

def generate_embeddings_in_batches(texts):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –±–∞—Ç—á–∞–º–∏."""
    all_embeddings = []
    successful_indices = []
    
    if not texts: return [], []

    num_batches = (len(texts) + config.BATCH_SIZE - 1) // config.BATCH_SIZE
    for i in tqdm(range(0, len(texts), config.BATCH_SIZE), total=num_batches, desc="API Gemini (Embeddings)"):
        batch_texts = texts[i:i + config.BATCH_SIZE]
        retries = 0
        success = False
        while retries < config.MAX_RETRIES:
            try:
                result = genai.embed_content(
                    model=f"models/{config.EMBEDDING_MODEL_NAME}",
                    content=batch_texts,
                    task_type="RETRIEVAL_DOCUMENT",
                    output_dimensionality=config.OUTPUT_DIMENSION
                )
                # Gemini –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å None –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –±–∞—Ç—á–µ, –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞—é—Ç —Ñ–∏–ª—å—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                embeddings = result.get('embedding', [])
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º
                if len(embeddings) != len(batch_texts):
                    # –≠—Ç–æ —Å–ª–æ–∂–Ω—ã–π –∫–µ–π—Å, –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –ø—Ä–æ–ø—É—Å—Ç–∏–º –±–∞—Ç—á
                    print(f"\n–í–Ω–∏–º–∞–Ω–∏–µ: Gemini –≤–µ—Ä–Ω—É–ª {len(embeddings)} –≤–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è {len(batch_texts)} —Ç–µ–∫—Å—Ç–æ–≤. –ë–∞—Ç—á –ø—Ä–æ–ø—É—â–µ–Ω.")
                    break

                all_embeddings.extend(embeddings)
                successful_indices.extend(range(i, i + len(embeddings)))
                success = True
                break
            except Exception as e:
                retries += 1
                print(f"\n–û—à–∏–±–∫–∞ –±–∞—Ç—á–∞ {i} (–ø–æ–ø—ã—Ç–∫–∞ {retries}): {e}")
                time.sleep(2 * retries)
        
        if not success:
             # –ó–∞–ø–æ–ª–Ω—è–µ–º None, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é —Å–ø–∏—Å–∫–∞ texts
             all_embeddings.extend([None] * len(batch_texts))

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã API.
        # –ù–µ–±–æ–ª—å—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ –∂–¥–µ–º –ø–æ—Å–ª–µ —Å–∞–º–æ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ç—á–∞.
        if i + config.BATCH_SIZE < len(texts):
            time.sleep(config.API_REQUEST_DELAY)

    return all_embeddings, successful_indices

def main(full_reindex=False):
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.
    :param full_reindex: –ï—Å–ª–∏ True, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.
                         –ï—Å–ª–∏ False (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.
    """
    is_incremental = not full_reindex

    conn = sqlite3.connect(config.DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    if is_incremental and os.path.exists(config.INDEX_FILE):
        print("--- –†–µ–∂–∏–º: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ---")
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∏–≥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –±—ã–ª–∏ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
        cursor.execute("""
            SELECT pocketbase_id, title, full_text, summary 
            FROM games 
            WHERE last_indexed_at IS NULL 
            AND ((full_text IS NOT NULL AND full_text != '') OR (summary IS NOT NULL AND summary != ''))
        """)
    else:
        if is_incremental:
            print("–§–∞–π–ª –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è.")
        else:
            print("--- –†–µ–∂–∏–º: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ---")
        full_reindex = True # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –ø–æ–ª–Ω—ã–π —Ä–µ–∂–∏–º
        is_incremental = False
        # –ë–µ—Ä–µ–º –í–°–ï –∏–≥—Ä—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Å–∞–º–º–∞—Ä–∏)
        cursor.execute("""
            SELECT pocketbase_id, title, full_text, summary 
            FROM games 
            WHERE (full_text IS NOT NULL AND full_text != '') OR (summary IS NOT NULL AND summary != '')
        """)

    all_games = cursor.fetchall()

    if not all_games:
        print("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–≥—Ä –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.")
        if is_incremental:
            print("–í—Å–µ –∏–≥—Ä—ã —É–∂–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã.")
        conn.close()
        return

    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(all_games)} –∏–≥—Ä. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —á–∞–Ω–∫–æ–≤...")

    texts_to_embed = []
    temp_chunk_map = [] # –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

    # –ï—Å–ª–∏ —ç—Ç–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –Ω–∞–º –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —á–∞–Ω–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª—è–µ–º—ã—Ö –∏–≥—Ä
    if is_incremental:
        game_ids_to_update = {game['pocketbase_id'] for game in all_games}
        print(f"–ë—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è {len(game_ids_to_update)} –∏–≥—Ä.")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        with open(config.MAPPING_FILE, 'r', encoding='utf-8') as f:
            old_chunk_map = {int(k): v for k, v in json.load(f).items()}
        
        ids_to_remove = [
            faiss_id for faiss_id, meta in old_chunk_map.items() 
            if meta['game_id'] in game_ids_to_update
        ]
        
        if ids_to_remove:
            print(f"–ù–∞–π–¥–µ–Ω–æ {len(ids_to_remove)} —Å—Ç–∞—Ä—ã—Ö —á–∞–Ω–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–Ω–¥–µ–∫—Å–∞.")
            # Faiss –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ IndexFlatIP.
            # –ü—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.
            print("–í–Ω–∏–º–∞–Ω–∏–µ: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–≥—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è.")
            full_reindex = True
            return main(full_reindex=True) # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

    for game in tqdm(all_games, desc="–ß–∞–Ω–∫–∏–Ω–≥"):
        game_id = game['pocketbase_id']
        game_title = game['title']
        
        # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ SUMMARY (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if game['summary']:
            # –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π, –≤–∞–∂–Ω—ã–π —á–∞–Ω–∫.
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–∞–º —Ç–µ–∫—Å—Ç –¥–ª—è –ª—É—á—à–µ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏.
            enriched_summary = f"Summary/Description of CYOA game '{game_title}': {game['summary']}"
            texts_to_embed.append(enriched_summary)
            temp_chunk_map.append({
                "game_id": game_id,
                "type": "summary", # –ú–µ—Ç–∫–∞ —Ç–∏–ø–∞
                "text_snippet": game['summary'][:300] + "..." # –î–ª—è –¥–µ–±–∞–≥–∞ –≤ JSON
            })

        # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ FULL_TEXT (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if game['full_text']:
            raw_chunks = chunk_raw_text(game['full_text'])
            for chunk in raw_chunks:
                enriched_chunk = f"Text excerpt from CYOA game '{game_title}': {chunk}"
                texts_to_embed.append(enriched_chunk)
                temp_chunk_map.append({
                    "game_id": game_id,
                    "type": "text", # –ú–µ—Ç–∫–∞ —Ç–∏–ø–∞
                    "text_snippet": chunk[:200] + "..."
                })

    print(f"–í—Å–µ–≥–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ {len(texts_to_embed)} —á–∞–Ω–∫–æ–≤ (Summary + Text).")

    # --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ ---
    raw_embeddings, successful_indices = generate_embeddings_in_batches(texts_to_embed)

    if not successful_indices:
        print("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏.")
        conn.close()
        return

    # --- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ Faiss ---
    new_embeddings = [raw_embeddings[i] for i in successful_indices if raw_embeddings[i] is not None]
    embeddings_np = np.array(new_embeddings).astype('float32')
    print("–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤ (L2) –¥–ª—è Cosine Similarity...")
    faiss.normalize_L2(embeddings_np)

    if full_reindex:
        print(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ IndexFlatIP –¥–ª—è {len(embeddings_np)} –≤–µ–∫—Ç–æ—Ä–æ–≤...")
        index = faiss.IndexFlatIP(config.OUTPUT_DIMENSION)
        index.add(embeddings_np)
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É —á–∞–Ω–∫–æ–≤
        final_chunk_map = {}
        successful_chunks = [temp_chunk_map[i] for i in successful_indices if raw_embeddings[i] is not None]
        for i, chunk_meta in enumerate(successful_chunks):
            final_chunk_map[i] = chunk_meta
    else: # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
        print("–ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...")
        index = faiss.read_index(config.INDEX_FILE)
        with open(config.MAPPING_FILE, 'r', encoding='utf-8') as f:
            final_chunk_map = {int(k): v for k, v in json.load(f).items()}

        start_id = index.ntotal
        print(f"–ò–Ω–¥–µ–∫—Å —Å–æ–¥–µ—Ä–∂–∏—Ç {start_id} –≤–µ–∫—Ç–æ—Ä–æ–≤. –î–æ–±–∞–≤–ª—è–µ–º {len(embeddings_np)} –Ω–æ–≤—ã—Ö...")
        index.add(embeddings_np)

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ä—Ç—É
        successful_chunks = [temp_chunk_map[i] for i in successful_indices if raw_embeddings[i] is not None]
        for i, chunk_meta in enumerate(successful_chunks):
            final_chunk_map[start_id + i] = chunk_meta

    # --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---
    print("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏ –∫–∞—Ä—Ç—ã...")
    faiss.write_index(index, config.INDEX_FILE)
    with open(config.MAPPING_FILE, 'w', encoding='utf-8') as f:
        json.dump(final_chunk_map, f, ensure_ascii=False, indent=2)

    # --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î ---
    # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ç–µ—Ö –∏–≥—Ä, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤ —ç—Ç–æ–º –∑–∞–ø—É—Å–∫–µ
    processed_game_ids = {game['pocketbase_id'] for game in all_games}
    if processed_game_ids:
        current_time = datetime.now().isoformat()
        placeholders = ', '.join('?' for _ in processed_game_ids)
        cursor.execute(
            f"UPDATE games SET last_indexed_at = ? WHERE pocketbase_id IN ({placeholders})",
            (current_time, *processed_game_ids)
        )
        conn.commit()
        print(f"–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è {len(processed_game_ids)} –∏–≥—Ä.")

    # --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î ---
    print("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...")
    processed_game_ids = set([info['game_id'] for info in final_chunk_map.values()])
    
    if processed_game_ids:
        current_time = datetime.now().isoformat()
        placeholders = ', '.join('?' for _ in processed_game_ids)
        cursor.execute(
            f"UPDATE games SET last_indexed_at = ? WHERE pocketbase_id IN ({placeholders})",
            (current_time, *processed_game_ids)
        )
        conn.commit()
        print(f"–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è {len(processed_game_ids)} –∏–≥—Ä.")

    conn.close()
    print("\n--- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ---")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="–ò–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–π –∏–≥—Ä –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.")
    parser.add_argument(
        '--full',
        action='store_true',
        help="–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö, —É–¥–∞–ª–∏–≤ —Å—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å."
    )
    args = parser.parse_args()
    main(full_reindex=args.full)

============================================================
FILE PATH: ./clear_database.py
============================================================
# clear_database.py
import sqlite3
import os
import config

def clear_all_games():
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã 'games', –Ω–µ —É–¥–∞–ª—è—è —Å–∞–º—É —Ç–∞–±–ª–∏—Ü—É."""
    if not os.path.exists(config.DB_FILE):
        print(f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{config.DB_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ—á–µ–≥–æ –æ—á–∏—â–∞—Ç—å.")
        return

    try:
        conn = sqlite3.connect(config.DB_FILE)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        cursor.execute("SELECT COUNT(*) FROM games")
        count_before = cursor.fetchone()[0]

        if count_before == 0:
            print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –ø—É—Å—Ç–∞.")
            conn.close()
            return
            
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        confirm = input(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å {count_before} –∏–≥—Ä –∏–∑ –±–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. (y/n): ")
        
        if confirm.lower() == 'y':
            print("–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π...")
            # –ì–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã games
            cursor.execute("DELETE FROM games")
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã ID —Å–Ω–æ–≤–∞ –Ω–∞—á–∏–Ω–∞–ª–∏—Å—å —Å 1
            cursor.execute("DELETE FROM sqlite_sequence WHERE name='games'")
            conn.commit()
            print("–í—Å–µ –∏–≥—Ä—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞.")
        else:
            print("–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

        conn.close()
        
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    clear_all_games()

============================================================
FILE PATH: ./reset_index_status.py
============================================================
# reset_index_status.py
import sqlite3
import os
import config

def reset_all_statuses():
    """
    –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–ª—è –í–°–ï–• –∏–≥—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö,
    —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è last_indexed_at –≤ NULL.
    –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç indexer.py –ø–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ.
    """
    if not os.path.exists(config.DB_FILE):
        print(f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{config.DB_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ—á–µ–≥–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å.")
        return

    try:
        conn = sqlite3.connect(config.DB_FILE)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        cursor.execute("SELECT COUNT(*) FROM games WHERE last_indexed_at IS NOT NULL")
        count_before = cursor.fetchone()[0]

        if count_before == 0:
            print("–í—Å–µ –∏–≥—Ä—ã –≤ –±–∞–∑–µ —É–∂–µ –≥–æ—Ç–æ–≤—ã –∫ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (—Å—Ç–∞—Ç—É—Å —Å–±—Ä–æ—à–µ–Ω).")
            conn.close()
            return
            
        print(f"–ù–∞–π–¥–µ–Ω–æ {count_before} –∏–≥—Ä —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ–± –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.")
        confirm = input(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¥–ª—è —ç—Ç–∏—Ö –∏–≥—Ä? (y/n): ")
        
        if confirm.lower() == 'y':
            print("–°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏...")
            # –ì–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å last_indexed_at –≤ NULL –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
            cursor.execute("UPDATE games SET last_indexed_at = NULL")
            
            conn.commit()
            print(f"–°—Ç–∞—Ç—É—Å –¥–ª—è {cursor.rowcount} –∏–≥—Ä –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω.")
            print("–¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ `indexer.py` –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Ö –≤—Å–µ –∑–∞–Ω–æ–≤–æ.")
        else:
            print("–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

        conn.close()
        
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    reset_all_statuses()

============================================================
FILE PATH: ./requirements.txt
============================================================
annotated-types==0.7.0
anyio==4.11.0
attrs==25.4.0
beautifulsoup4==4.14.2
cachetools==6.2.1
certifi==2025.10.5
chardet==5.2.0
charset-normalizer==3.4.4
click==8.3.0
distro==1.9.0
docstring_parser==0.17.0
docutils==0.22.2
faiss-cpu==1.12.0
fastapi==0.119.0
flit==3.12.0
flit_core==3.12.0
gitignore_parser==0.1.13
google-ai-generativelanguage==0.6.15
google-api-core==2.26.0
google-api-python-client==2.184.0
google-auth==2.41.1
google-auth-httplib2==0.2.0
google-cloud-aiplatform==1.121.0
google-cloud-bigquery==3.38.0
google-cloud-core==2.4.3
google-cloud-resource-manager==1.14.2
google-cloud-storage==2.19.0
google-cloud-vision==3.10.2
google-crc32c==1.7.1
google-genai==1.45.0
google-generativeai==0.8.5
google-resumable-media==2.7.2
googleapis-common-protos==1.70.0
gpt-repository-loader==0.10.0
grpc-google-iam-v1==0.14.3
grpcio==1.75.1
grpcio-status==1.71.2
h11==0.16.0
httpcore==1.0.9
httplib2==0.31.0
httptools==0.7.1
httpx==0.28.1
idna==3.11
jiter==0.11.1
numpy==2.3.3
openai==2.4.0
outcome==1.3.0.post0
packaging==25.0
pathspec==0.12.1
pocketbase==0.15.0
pocketbase-client==0.2.3
proto-plus==1.26.1
protobuf==5.29.5
pyasn1==0.6.1
pyasn1_modules==0.4.2
pydantic==2.12.2
pydantic_core==2.41.4
pyparsing==3.2.5
pyperclip==1.11.0
PySocks==1.7.1
python-dateutil==2.9.0.post0
python-dotenv==1.1.1
PyYAML==6.0.3
regex==2025.9.18
requests==2.32.5
rsa==4.9.1
selenium==4.36.0
shapely==2.1.2
six==1.17.0
sniffio==1.3.1
sortedcontainers==2.4.0
soupsieve==2.8
starlette==0.48.0
tabulate==0.9.0
tenacity==9.1.2
tiktoken==0.12.0
token-count==0.2.1
tomli_w==1.2.0
tqdm==4.67.1
trio==0.31.0
trio-websocket==0.12.2
typing-inspection==0.4.2
typing_extensions==4.15.0
uritemplate==4.2.0
urllib3==2.5.0
uvicorn==0.37.0
uvloop==0.21.0
watchfiles==1.1.1
webdriver-manager==4.0.2
websocket-client==1.9.0
websockets==15.0.1
wsproto==1.2.0


============================================================
FILE PATH: ./summary_prompt.txt
============================================================
You are an expert cataloger of Choose Your Own Adventure (CYOA), interactive fiction, and visual novel games.
Your task is to analyze the provided raw text of a game and generate a comprehensive, structured summary designed to optimize semantic search and tagging.

The raw text may include code snippets, UI elements, or fragmented narratives. Ignore technical formatting and focus on the content.

Generate a summary that fits within 1500 words. Do not use Markdown formatting (no bolding, no lists with asterisks). Just plain text paragraphs.

Structure the summary to include the following information intuitively:

1.  **Genre & Setting:** clearly define the genre (e.g., High Fantasy, Cyberpunk, Slice of Life, Horror) and the world the game takes place in.
2.  **Premise & Protagonist:** Who is the player character? What is their initial goal or driving conflict?
3.  **Gameplay & Mechanics:** Is it text-heavy? Are there stat management, inventory systems, combat, or relationship tracking?
4.  **Tone & Themes:** Describe the atmosphere (e.g., dark, humorous, cozy, intense) and main themes (e.g., survival, romance, power, corruption).
5.  **Content & Tags:** Explicitly mention key elements users might search for. Examples: gender-selectable protagonist, character customization, magic systems, specific fetishes or NSFW content (if apparent), LGBTQ+ themes, multiple endings.

End the summary with a paragraph listing comma-separated keywords and tags derived from the analysis.

Input Game Text:

============================================================
FILE PATH: ./generate_summary.py
============================================================
# generate_summary.py
import sqlite3
import os
import argparse
import concurrent.futures
from dotenv import load_dotenv
from openai import OpenAI
from tqdm import tqdm
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
if not OPENROUTER_API_KEY:
    raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω OPENROUTER_API_KEY –≤ .env —Ñ–∞–π–ª–µ")

def load_prompt():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞."""
    if not os.path.exists(config.SUMMARY_PROMPT_FILE):
        raise FileNotFoundError(f"–ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –ø—Ä–æ–º–ø—Ç–∞: {config.SUMMARY_PROMPT_FILE}")
    with open(config.SUMMARY_PROMPT_FILE, 'r', encoding='utf-8') as f:
        return f.read().strip()

# <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–∏–ª–∏ 'game_title' –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ --->
def generate_summary_with_openrouter(client, model_name, base_prompt, game_title, game_text):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏–≥—Ä—ã –≤ OpenRouter –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ."""
    try:
        # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–º–µ–Ω—å—à–∞–µ–º –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –≤–ø–∏—Å–∞—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –º–æ–¥–µ–ª–∏ --->
        # –õ–∏–º–∏—Ç –º–æ–¥–µ–ª–∏ ~163k —Ç–æ–∫–µ–Ω–æ–≤. 500k —Å–∏–º–≤–æ–ª–æ–≤ —ç—Ç–æ ~125k —Ç–æ–∫–µ–Ω–æ–≤, —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.
        max_chars = 500000
        
        if len(game_text) > max_chars:
             # –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω
             tqdm.write(f"  [INFO] –¢–µ–∫—Å—Ç –¥–ª—è '{game_title}' —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ({len(game_text)} —Å–∏–º–≤.), –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –¥–æ {max_chars}.")
        
        truncated_text = game_text[:max_chars]
        
        response = client.chat.completions.create(
            model=model_name,
            messages=[
                {
                    "role": "system",
                    "content": base_prompt
                },
                {
                    "role": "user",
                    "content": f"Input Game Text:\n{truncated_text}"
                }
            ],
            temperature=0.2,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –µ–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        return f"API_ERROR: {e}"

def process_game(game_data, client, model_name, base_prompt):
    """
    –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–¥–Ω–æ–π –∏–≥—Ä—ã. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
    """
    pb_id, title, full_text = game_data
    # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º 'title' –≤ —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ --->
    summary = generate_summary_with_openrouter(client, model_name, base_prompt, title, full_text)
    return pb_id, title, summary

def run_summary_generation(limit=None, workers=5):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π. –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤.
    """
    base_prompt = load_prompt()
    client = OpenAI(
      base_url="https://openrouter.ai/api/v1",
      api_key=OPENROUTER_API_KEY,
    )

    conn = sqlite3.connect(config.DB_FILE)
    cursor = conn.cursor()

    query = """
        SELECT pocketbase_id, title, full_text 
        FROM games 
        WHERE full_text IS NOT NULL AND full_text != '' AND (summary IS NULL OR summary = '')
    """
    
    params = ()
    if limit:
        query += " LIMIT ?"
        params = (limit,)
        print(f"--- –†–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –±–æ–ª–µ–µ {limit} –∏–≥—Ä ---")

    cursor.execute(query, params)
    games_to_process = cursor.fetchall()

    if not games_to_process:
        print("–ù–µ—Ç –∏–≥—Ä, —Ç—Ä–µ–±—É—é—â–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è.")
        conn.close()
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(games_to_process)} –∏–≥—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π —Å –ø–æ–º–æ—â—å—é {config.GENERATION_MODEL_NAME} —á–µ—Ä–µ–∑ OpenRouter.")
    print(f"–ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ {workers} –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤...")
    
    success_count = 0
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=workers) as executor:
        future_to_game = {
            executor.submit(process_game, game, client, config.GENERATION_MODEL_NAME, base_prompt): game
            for game in games_to_process
        }
        
        progress_bar = tqdm(concurrent.futures.as_completed(future_to_game), total=len(games_to_process), desc="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π")
        
        for future in progress_bar:
            pb_id, title, summary = future.result()
            
            if summary and not summary.startswith("API_ERROR:"):
                cursor.execute(
                    "UPDATE games SET summary = ?, last_indexed_at = NULL WHERE pocketbase_id = ?",
                    (summary, pb_id)
                )
                conn.commit()
                success_count += 1
            else:
                tqdm.write(f"\n[FAIL] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è '{title}'. –û—à–∏–±–∫–∞: {summary}")

    conn.close()
    print(f"\n–ó–∞–≤–µ—Ä—à–µ–Ω–æ. –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–π: {success_count}/{len(games_to_process)}.")
    if success_count > 0:
        print("–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'python indexer.py', —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å.")

def main():
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é. –ü–∞—Ä—Å–∏—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.
    """
    parser = argparse.ArgumentParser(description="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ–ø–∏—Å–∞–Ω–∏–π –∏–≥—Ä —Å –ø–æ–º–æ—â—å—é OpenRouter.")
    parser.add_argument('--limit', type=int, default=None, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫.")
    parser.add_argument('--workers', type=int, default=5, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API.")
    args = parser.parse_args()
    run_summary_generation(limit=args.limit, workers=args.workers)

if __name__ == "__main__":
    main()

============================================================
FILE PATH: ./main.py
============================================================
# main.py (–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú –ó–ê–ü–†–û–°–û–í)
import os
import json
import numpy as np
import faiss
import google.generativeai as genai
import sqlite3
from dotenv import load_dotenv
from fastapi import FastAPI, HTTPException, Query
from fastapi.staticfiles import StaticFiles, Depends
from fastapi.responses import FileResponse
from typing import List, Dict, Any
from enum import Enum
from collections import defaultdict
from datetime import datetime # <--- –ù–û–í–´–ô –ò–ú–ü–û–†–¢
import math
import logging
from fastapi.middleware.cors import CORSMiddleware 
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
genai.configure(api_key=GOOGLE_API_KEY)

# --- –°–ï–ö–¶–ò–Ø: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ---
# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ ---
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–≥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
if config.DEBUG_LOGGING:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º getLogger, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å uvicorn --reload
    logger = logging.getLogger(__name__)
    if not logger.handlers:
        logger.setLevel(logging.INFO)
        # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        for handler in logger.handlers[:]:
            logger.removeHandler(handler)
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞
        file_handler = logging.FileHandler(config.LOG_FILE, mode='a', encoding='utf-8')
        file_handler.setFormatter(logging.Formatter('%(asctime)s - %(message)s'))
        logger.addHandler(file_handler)

        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
        console_handler = logging.StreamHandler()
        console_handler.setFormatter(logging.Formatter('%(message)s')) # –§–æ—Ä–º–∞—Ç –ø–æ–∫–æ—Ä–æ—á–µ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        logger.addHandler(console_handler)
else:
    # –ï—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º "–ø—É—Å—Ç—ã—à–∫—É", —á—Ç–æ–±—ã –∫–æ–¥ –Ω–µ –ø–∞–¥–∞–ª
    class DummyLogger:
        def info(self, msg, *args, **kwargs): pass
    logger = DummyLogger()

# --- –ù–û–í–´–ô –ë–õ–û–ö: –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–†–û–°–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò ---
QUERY_LOG_FILE = config.QUERY_LOG_FILE

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –≤–∏–¥–µ JSON
query_logger = logging.getLogger('user_queries')
query_logger.setLevel(logging.INFO)

# –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
query_logger.propagate = False

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
if not query_logger.handlers:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º mode='a' –¥–ª—è –¥–æ–∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª
    query_handler = logging.FileHandler(QUERY_LOG_FILE, mode='a', encoding='utf-8')
    # –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –≤—ã–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç.–∫. –º—ã –ø–µ—Ä–µ–¥–∞–µ–º –≥–æ—Ç–æ–≤—É—é JSON-—Å—Ç—Ä–æ–∫—É
    query_handler.setFormatter(logging.Formatter('%(message)s'))
    query_logger.addHandler(query_handler)
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
# --- –ö–û–ù–ï–¶ –°–ï–ö–¶–ò–ò –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ---


class SearchMode(str, Enum):
    mixed = "mixed"
    summary = "summary"
    text = "text"

app = FastAPI(title="CYOA Semantic Search API v5 (User Query Logging)")


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
origins = [
    "https://cyoa.cafe",      # –ê–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞
    "http://localhost:5173", # –ê–¥—Ä–µ—Å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ React (–ø–æ—Ä—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–º)
    "http://127.0.0.1:5173",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"], # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã (GET, POST –∏ —Ç.–¥.)
    allow_headers=["*"], # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ    
faiss_index = None
chunk_map = {}

@app.on_event("startup")
def load_data():
    global faiss_index, chunk_map
    print("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –∏ –∫–∞—Ä—Ç—ã...")
    if os.path.exists(config.INDEX_FILE) and os.path.exists(config.MAPPING_FILE):
        faiss_index = faiss.read_index(config.INDEX_FILE)
        with open(config.MAPPING_FILE, 'r', encoding='utf-8') as f:
            chunk_map = {int(k): v for k, v in json.load(f).items()}
        print(f"–ò–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω: {faiss_index.ntotal} –≤–µ–∫—Ç–æ—Ä–æ–≤.")
    else:
        print("WARN: –§–∞–π–ª—ã –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∏—Å–∫ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")

# --- –ù–û–í–´–ô –ë–õ–û–ö: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î —á–µ—Ä–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ---
def get_db_connection():
    """
    FastAPI –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î.
    –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ –ø–æ—Å–ª–µ.
    """
    connection = sqlite3.connect(config.DB_FILE)
    try:
        yield connection
    finally:
        connection.close()
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

@app.get("/api/semantic-search")
async def search_games(
    q: str = Query(..., min_length=2),
    mode: SearchMode = Query(SearchMode.mixed, description="–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: –ø–æ —Ç–µ–∫—Å—Ç—É, –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ —Å–º–µ—à–∞–Ω–Ω—ã–π"),
    k: int = 200,
    threshold: float = 0.40, 
    conn: sqlite3.Connection = Depends(get_db_connection) # <--- –ò–ù–™–ï–ö–¶–ò–Ø –ó–ê–í–ò–°–ò–ú–û–°–¢–ò
):
    if not faiss_index or not chunk_map:
        raise HTTPException(status_code=503, detail="–ò–Ω–¥–µ–∫—Å –Ω–µ –≥–æ—Ç–æ–≤.")

    logger.info(f"\n{'='*25} –ù–û–í–´–ô –ü–û–ò–°–ö–û–í–´–ô –ó–ê–ü–†–û–° {'='*25}")
    logger.info(f"Query: '{q}' | Mode: {mode} | k: {k} | threshold: {threshold}")
    
    try:
        # 1. –≠–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞
        q_emb = genai.embed_content(
            model=f"models/{config.EMBEDDING_MODEL_NAME}",
            content=q,
            task_type="RETRIEVAL_QUERY",
            output_dimensionality=config.OUTPUT_DIMENSION
        )['embedding']
        q_vec = np.array([q_emb]).astype('float32')
        faiss.normalize_L2(q_vec)

        # 2. –§–∞–∑–∞ 1: Retrieval - –ü–æ–∏—Å–∫ K –±–ª–∏–∂–∞–π—à–∏—Ö –ß–ê–ù–ö–û–í
        D, I = faiss_index.search(q_vec, k)
        
        indices = I[0]
        scores = D[0]
        logger.info(f"[–§–∞–∑–∞ 1] –ü–æ–∏—Å–∫ –≤ Faiss. –ù–∞–π–¥–µ–Ω–æ {len(indices)} –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —á–∞–Ω–∫–æ–≤-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.")

        # 3. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–≥—Ä–∞–º
        game_data = defaultdict(lambda: {"summary_chunks": [], "text_chunks": []})

        for idx, raw_score in zip(indices, scores):
            if idx == -1 or raw_score < threshold: continue
            
            chunk_info = chunk_map.get(int(idx))
            if not chunk_info: continue

            game_id = chunk_info['game_id']
            chunk_type = chunk_info.get('type', 'text')

            if mode == SearchMode.summary and chunk_type != 'summary': continue
            if mode == SearchMode.text and chunk_type != 'text': continue
            
            chunk_details = {
                "score": float(raw_score),
                "snippet": chunk_info.get('text_snippet', 'N/A')
            }

            if chunk_type == 'summary':
                game_data[game_id]["summary_chunks"].append(chunk_details)
            else:
                game_data[game_id]["text_chunks"].append(chunk_details)

        if not game_data:
            logger.info("–ü–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω –Ω–∏ –æ–¥–Ω–∏–º —á–∞–Ω–∫–æ–º. –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç.")
            return {"results": [], "mode_used": mode}
        
        logger.info(f"\n--- [–§–∞–∑–∞ 2] –ê–≥—Ä–µ–≥–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤ –ø–æ {len(game_data)} –∏–≥—Ä–∞–º ---")
        for game_id, data in game_data.items():
            logger.info(f"–ò–≥—Ä–∞ ID: {game_id}")
            for chunk in data['summary_chunks']:
                logger.info(f"  [SUMMARY] Score: {chunk['score']:.4f} | Snippet: {chunk['snippet']}")
            for chunk in data['text_chunks']:
                logger.info(f"  [TEXT]    Score: {chunk['score']:.4f} | Snippet: {chunk['snippet']}")

        # 4. –§–∞–∑–∞ 2: Re-ranking - –ü—Ä–∏–º–µ–Ω—è–µ–º "–ó–æ–ª–æ—Ç—É—é —Ñ–æ—Ä–º—É–ª—É"
        logger.info("\n--- [–§–∞–∑–∞ 3] –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç '–í–æ–ª—à–µ–±–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã' ---")
        final_game_scores = {}

        for game_id, data in game_data.items():
            summary_scores = [c['score'] for c in data['summary_chunks']]
            text_scores = [c['score'] for c in data['text_chunks']]
            
            summary_score = max(summary_scores or [0])
            
            text_score = 0
            sorted_text_scores = sorted(text_scores, reverse=True)
            for i, score in enumerate(sorted_text_scores):
                text_score += score * (DECAY_FACTOR ** i)
            
            normalizing_divisor = 5.0 
            normalized_text_score = math.log1p(text_score) / normalizing_divisor if text_score > 0 else 0

            final_score = (summary_score * SUMMARY_WEIGHT) + (normalized_text_score * TEXT_WEIGHT)
            
            final_game_scores[game_id] = {
                "score": final_score,
                "match_type": "summary" if summary_score > 0 else "text"
            }
            
            log_msg = (
                f"–†–∞—Å—á–µ—Ç –¥–ª—è –∏–≥—Ä—ã ID: {game_id}\n"
                f"  - Summary Scores: {[f'{s:.4f}' for s in summary_scores]}\n"
                f"  - -> Max Summary Score (A): {summary_score:.4f}\n"
                f"  - Text Scores (sorted): {[f'{s:.4f}' for s in sorted_text_scores]}\n"
                f"  - -> Raw Text Score (decayed sum): {text_score:.4f}\n"
                f"  - -> Normalized Text Score (B): {normalized_text_score:.4f}\n"
                f"  >>> –ò–¢–û–ì–û–í–ê–Ø –§–û–†–ú–£–õ–ê: (A * {config.SUMMARY_WEIGHT}) + (B * {config.TEXT_WEIGHT})\n"
                f"  >>> –†–ï–ó–£–õ–¨–¢–ê–¢: ({summary_score:.4f} * {config.SUMMARY_WEIGHT}) + ({normalized_text_score:.4f} * {config.TEXT_WEIGHT}) = {final_score:.4f}"
            )
            logger.info(log_msg)
            
        # 5. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤—ã–±–æ—Ä —Ç–æ–ø-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        sorted_games = sorted(final_game_scores.items(), key=lambda item: item[1]["score"], reverse=True)
        top_games = sorted_games[:20]
        top_game_ids = [g_id for g_id, data in top_games]

        if not top_game_ids:
            return {"results": [], "mode_used": mode}
        
        logger.info("\n--- [–§–∞–∑–∞ 4] –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–ø-20 ---")
        for i, (game_id, score_data) in enumerate(top_games):
             logger.info(f"  #{i+1}: ID={game_id}, Final Score={score_data['score']:.4f}")

        # 6. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        cursor = conn.cursor()
        placeholders = ','.join('?' * len(top_game_ids))
        sql = f"SELECT pocketbase_id, title, summary, original_url FROM games WHERE pocketbase_id IN ({placeholders})"
        cursor.execute(sql, top_game_ids)
        rows = cursor.fetchall()

        game_meta_map = {row[0]: (row[1], row[2]) for row in rows}
        
        results = []
        for game_id, score_data in top_games:
            meta = game_meta_map.get(game_id)
            if meta:
                title, summary, original_url = meta
                summary_snippet = (summary[:200] + "...") if summary else ""
                
                display_score = min(int(score_data["score"] * 100), 100)

                results.append({
                    "id": game_id,
                    "title": title,
                    "url": original_url or f"{config.BASE_GAME_URL}{game_id}",
                    "score": display_score,
                    "match_type": score_data["match_type"],
                    "snippet": summary_snippet
                })
        
        # --- –ù–û–í–´–ô –ë–õ–û–ö: –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---
        try:
            log_entry = {
                "timestamp": datetime.now().isoformat(),
                "query": q,
                "mode": mode.value,
                "results_count": len(results),
                "top_results": [
                    {"id": r["id"], "title": r["title"], "score": r["score"]} 
                    for r in results[:3]
                ]
            }
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JSON –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ª–æ–≥
            query_logger.info(json.dumps(log_entry, ensure_ascii=False))
        except Exception as log_e:
            # –ù–µ –ª–æ–º–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø–∞–ª–æ.
            print(f"ERROR: Could not write user query to log: {log_e}")
        # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
        
        logger.info(f"{'='*28} –ö–û–ù–ï–¶ –ó–ê–ü–†–û–°–ê {'='*28}\n")
        return {"results": results, "mode_used": mode}

    except Exception as e:
        logger.info(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–û–ò–°–ö–ê: {e}")
        # --- –ù–û–í–´–ô –ë–õ–û–ö: –õ–æ–≥–∏—Ä—É–µ–º —Ç–∞–∫–∂–µ –∏ –æ—à–∏–±–∫—É –≤ —Ñ–∞–π–ª –∑–∞–ø—Ä–æ—Å–æ–≤ ---
        try:
            log_entry = {
                "timestamp": datetime.now().isoformat(),
                "query": q,
                "mode": mode.value,
                "error": str(e)
            }
            query_logger.info(json.dumps(log_entry, ensure_ascii=False))
        except Exception as log_e:
             print(f"ERROR: Could not write user query error to log: {log_e}")
        # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
        raise HTTPException(status_code=500, detail=str(e))

# --- –°—Ç–∞—Ç–∏–∫–∞ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ—É—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
app.mount("/static", StaticFiles(directory="static"), name="static")

@app.get("/")
async def read_root():
    return FileResponse("static/index.html")

@app.get("/stats")
async def get_stats(conn: sqlite3.Connection = Depends(get_db_connection)):
    cur = conn.cursor()
    total = cur.execute("SELECT COUNT(*) FROM games").fetchone()[0]
    with_text = cur.execute("SELECT COUNT(*) FROM games WHERE full_text IS NOT NULL AND full_text != ''").fetchone()[0]
    with_summary = cur.execute("SELECT COUNT(*) FROM games WHERE summary IS NOT NULL AND summary != ''").fetchone()[0]
    indexed = cur.execute("SELECT COUNT(*) FROM games WHERE last_indexed_at IS NOT NULL").fetchone()[0]
    return {"total": total, "with_text": with_text, "with_summary": with_summary, "indexed": indexed}

@app.get("/games", response_model=List[Dict[str, Any]])
async def get_all_games(conn: sqlite3.Connection = Depends(get_db_connection)):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏."""
    try:
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute("""
            SELECT 
                title, 
                summary, 
                last_indexed_at 
            FROM games 
            ORDER BY title ASC
        """)
        rows = cursor.fetchall()

        games_list = []
        for row in rows:
            games_list.append({
                "title": row["title"],
                "summary": row["summary"],
                "has_summary": bool(row["summary"]),
                "is_indexed": row["last_indexed_at"] is not None
            })
        
        return games_list

    except Exception as e:
        print(f"Error fetching all games: {e}")
        raise HTTPException(status_code=500, detail="Could not fetch game list from database.")

============================================================
FILE PATH: ./sync_with_pocketbase.py
============================================================
# sync_with_pocketbase.py (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
import os
import sqlite3
import json
from dotenv import load_dotenv
# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–º–ø–æ—Ä—Ç, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å —Ç–≤–æ–µ–π –≤–µ—Ä—Å–∏–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ---
# –ú—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å 'Client' –∏ –¥–∞–µ–º –µ–º—É –ø—Å–µ–≤–¥–æ–Ω–∏–º 'PocketBase' –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è.
from pocketbase.client import Client as PocketBase
# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
DB_FILE = "games.db"
POCKETBASE_URL = "https://cyoa.cafe"
ADMIN_EMAIL = os.getenv('EMAIL')
ADMIN_PASSWORD = os.getenv('PASSWORD')

def sync_games():
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∏–≥—Ä—ã –∏–∑ PocketBase —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite."""
    print("–ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å PocketBase...")

    try:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
        client = PocketBase(POCKETBASE_URL)
        client.admins.auth_with_password(ADMIN_EMAIL, ADMIN_PASSWORD)
        print("–£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ PocketBase.")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ PocketBase: {e}")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    try:
        all_pb_games = client.collection("games").get_full_list(batch=200, query_params={"sort": "-created"})
        print(f"–ò–∑ PocketBase –ø–æ–ª—É—á–µ–Ω–æ {len(all_pb_games)} –∏–≥—Ä.")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä –∏–∑ PocketBase: {e}")
        conn.close()
        return

    added_count = 0
    updated_count = 0
    for game in all_pb_games:
        try:
            # –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä
            cursor.execute(
                "INSERT OR IGNORE INTO games (pocketbase_id, title) VALUES (?, ?)",
                (game.id, game.title)
            )
            if cursor.rowcount > 0:
                added_count += 1

            # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
            # –¢–∏–ø 1: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è CYOA (—Å—Å—ã–ª–∫–∞)
            if game.img_or_link == 'link' and game.iframe_url:
                cursor.execute(
                    "UPDATE games SET original_url = ? WHERE pocketbase_id = ?",
                    (game.iframe_url, game.id)
                )
                if cursor.rowcount > 0: updated_count += 1
            
            # –¢–∏–ø 2: –°—Ç–∞—Ç–∏—á–Ω–∞—è CYOA (–∫–∞—Ä—Ç–∏–Ω–∫–∏)
            elif game.img_or_link == 'img' and game.cyoa_pages:
                image_urls = []
                # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–µ URL –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫
                for filename in game.cyoa_pages:
                    url = f"{POCKETBASE_URL}/api/files/{game.collection_id}/{game.id}/{filename}"
                    image_urls.append(url)
                
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ JSON-—Å—Ç—Ä–æ–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                image_urls_json = json.dumps(image_urls)
                cursor.execute(
                    "UPDATE games SET image_urls = ? WHERE pocketbase_id = ?",
                    (image_urls_json, game.id)
                )
                if cursor.rowcount > 0: updated_count += 1

        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–≥—Ä—É {game.id} ({game.title}): {e}")

    conn.commit()
    conn.close()
    
    print("-" * 20)
    print("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    print(f"–î–æ–±–∞–≤–ª–µ–Ω–æ {added_count} –Ω–æ–≤—ã—Ö –∏–≥—Ä.")
    print(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∑–∞–ø–∏—Å–µ–π —Å URL-–∞–º–∏.")
    print("–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏!")

if __name__ == "__main__":
    sync_games()

============================================================
FILE PATH: ./fetch_game_text.py
============================================================
# fetch_game_text.py (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
import os
import re
import json
import sqlite3
import time
import requests
from urllib.parse import urljoin
from tqdm import tqdm
import chardet

from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –§—É–Ω–∫—Ü–∏—è json_to_text –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
def json_to_text(data):
    # ... (–∫–æ–¥ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
    texts = []
    if not isinstance(data, dict): return ""
    if 'rows' in data:
        for row in data.get('rows', []):
            if isinstance(row, dict):
                if row.get('titleText'): texts.append(row['titleText'])
                for obj in row.get('objects', []):
                     if isinstance(obj, dict) and obj.get('text'): texts.append(obj['text'])
    elif 'sections' in data:
        for section in data.get('sections', []):
            if isinstance(section, dict):
                if section.get('title'): texts.append(section['title'])
                if section.get('text'): texts.append(section['text'])
    elif 'content' in data:
         texts.append(data.get('content', ''))
    return "\n\n".join(filter(None, texts))

# --- –ö–ª–∞—Å—Å GameTextFetcher –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
class GameTextFetcher: 
    def __init__(self):
        self.session = requests.Session()
        self.driver = None
        self.js_json_pattern = re.compile(r'Store\(\{state:\{app:(.*?)\},getters:', re.DOTALL)
    def _init_driver(self):
        if self.driver is None:
            print("    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è headless-–±—Ä–∞—É–∑–µ—Ä–∞ (Selenium)...")
            options = Options()
            options.add_argument('--headless'); options.add_argument('--disable-gpu'); options.add_argument('--log-level=3')
            options.set_capability('goog:loggingPrefs', {'performance': 'ALL'})
            try:
                self.driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
            except Exception as e:
                print(f"    –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å WebDriver: {e}"); raise
    def _try_direct_project_json(self, base_url):
        """–°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ü—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —Å–∫–∞—á–∞—Ç—å project.json —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏."""
        project_url = urljoin(base_url, 'project.json')
        try:
            with self.session.get(project_url, timeout=60, stream=True) as response:
                if response.status_code == 200:
                    content_length = response.headers.get('content-length')
                    size_info = f"({int(content_length) / 1024 / 1024:.2f} MB)" if content_length else ""
                    print(f"    [OK] –ù–∞–π–¥–µ–Ω project.json. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É {size_info}...")
                    
                    content = response.content
                    
                    # --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ---
                    # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É —Å –ø–æ–º–æ—â—å—é chardet
                    detected_encoding = chardet.detect(content)['encoding']
                    if not detected_encoding:
                        detected_encoding = 'utf-8' # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    print(f"    [INFO] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∞: {detected_encoding}")
                    
                    # 2. –î–µ–∫–æ–¥–∏—Ä—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
                    text_content = content.decode(detected_encoding, errors='replace')
                    
                    # 3. –ü–∞—Ä—Å–∏–º —É–∂–µ —Å—Ç—Ä–æ–∫—É, –∞ –Ω–µ –±–∞–π—Ç—ã
                    json_data = json.loads(text_content)
                    
                    print(f"    [OK] project.json —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω.")
                    return json_data
        except requests.exceptions.Timeout:
            print(f"    [FAIL] –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ {project_url}."); return None
        except requests.RequestException as e:
            print(f"    [INFO] –ó–∞–ø—Ä–æ—Å –∫ project.json –Ω–µ —É–¥–∞–ª—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, –µ–≥–æ –Ω–µ—Ç): {e.__class__.__name__}"); return None
        except json.JSONDecodeError:
            print(f"    [FAIL] –§–∞–π–ª project.json —Å–∫–∞—á–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON."); return None
        except UnicodeDecodeError as e:
            print(f"    [FAIL] –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞, –¥–∞–∂–µ –ø–æ—Å–ª–µ chardet: {e}")
            return None
        return None
    def _try_selenium_extraction(self, game_url):
        self._init_driver()
        self.driver.get(game_url)
        time.sleep(7)
        logs = self.driver.get_log('performance')
        json_urls, js_urls = set(), set()
        for log in logs:
            try:
                message = json.loads(log['message'])['message']
                if message['method'] == 'Network.responseReceived':
                    url = message['params']['response']['url']
                    if url.endswith('.json'): json_urls.add(url)
                    elif url.endswith('.js'): js_urls.add(url)
            except (KeyError, json.JSONDecodeError): continue
        if json_urls:
            print(f"    [INFO] –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞: –Ω–∞–π–¥–µ–Ω–æ {len(json_urls)} JSON-—Ñ–∞–π–ª–æ–≤.")
            for url in json_urls:
                try:
                    response = self.session.get(url, timeout=30)
                    if response.status_code == 200:
                        print(f"    [OK] –£—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω JSON –∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞: {os.path.basename(url)}"); return response.json()
                except requests.RequestException: continue
        if js_urls:
            print(f"    [INFO] –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑: –Ω–∞–π–¥–µ–Ω–æ {len(js_urls)} JS-—Ñ–∞–π–ª–æ–≤.")
            for url in js_urls:
                try:
                    response = self.session.get(url, timeout=30)
                    if response.status_code != 200: continue
                    match = self.js_json_pattern.search(response.text)
                    if match:
                        json_str = match.group(1).strip()
                        print(f"    [OK] –ù–∞–π–¥–µ–Ω—ã –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ JS-—Ñ–∞–π–ª–µ: {os.path.basename(url)}"); return json.loads(json_str)
                except (requests.RequestException, json.JSONDecodeError): continue
        return None
    def fetch(self, game_url):
        if game_url.endswith('index.html'): game_url = game_url[:-10]
        print("  - –ü–æ–ø—ã—Ç–∫–∞ 1: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ project.json...")
        json_data = self._try_direct_project_json(game_url)
        if json_data:
            text = json_to_text(json_data)
            if text: print("    [SUCCESS] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ project.json!"); return text
            else: print("    [WARN] project.json –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–Ω–∞–ª–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã...")
        print("  - –ü–æ–ø—ã—Ç–∫–∞ 2: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ Selenium...")
        try:
            json_data_selenium = self._try_selenium_extraction(game_url)
            if json_data_selenium:
                text = json_to_text(json_data_selenium)
                if text: print("    [SUCCESS] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã!"); return text
                else: print("    [WARN] –î–∞–Ω–Ω—ã–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–µ–Ω—ã, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–∫—Å—Ç–∞.")
        except Exception as e:
            print(f"    [ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ Selenium: {e}"); return None
        print("    [FAIL] –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –Ω–∏ –æ–¥–Ω–∏–º –∏–∑ –º–µ—Ç–æ–¥–æ–≤."); return None
    def close(self):
        if self.driver: print("–ó–∞–∫—Ä—ã—Ç–∏–µ headless-–±—Ä–∞—É–∑–µ—Ä–∞..."); self.driver.quit(); self.driver = None


def main():
    """
    –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å: –Ω–∞–π—Ç–∏ –∏–≥—Ä—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –Ω–∏—Ö Fetcher.
    """
    conn = sqlite3.connect(config.DB_FILE)
    cursor = conn.cursor()

    # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å –º—ã –≤—ã–±–∏—Ä–∞–µ–º –∏ original_url
    cursor.execute("SELECT pocketbase_id, title, original_url FROM games WHERE full_text IS NULL OR full_text = ''")
    games_to_process = cursor.fetchall()

    if not games_to_process:
        print("–í—Å–µ –∏–≥—Ä—ã —É–∂–µ –∏–º–µ—é—Ç —Ç–µ–∫—Å—Ç. –ù–µ—á–µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.")
        conn.close()
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(games_to_process)} –∏–≥—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.")
    
    fetcher = GameTextFetcher()
    success_count = 0
    fail_count = 0
    
    try:
        # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í —Ü–∏–∫–ª–µ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∏ original_url
        for pb_id, title, original_url in tqdm(games_to_process, desc="–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–≥—Ä"):
            
            # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞. –ï—Å–ª–∏ URL –Ω–µ—Ç, –º—ã –Ω–µ –º–æ–∂–µ–º –Ω–∏—á–µ–≥–æ —Å–¥–µ–ª–∞—Ç—å.
            try:
                if not original_url:
                    tqdm.write(f"\n-> [SKIP] –ü—Ä–æ–ø—É—Å–∫ '{title}', —Ç–∞–∫ –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.")
                    fail_count += 1
                    continue

                tqdm.write(f"\n-> –û–±—Ä–∞–±–æ—Ç–∫–∞: '{title}' ({original_url})")
                
                text_content = fetcher.fetch(original_url)

                if text_content:
                    cursor.execute(
                        "UPDATE games SET full_text = ? WHERE pocketbase_id = ?",
                        (text_content, pb_id)
                    )
                    conn.commit()
                    success_count += 1
                else:
                    fail_count += 1
            except Exception as e:
                # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
                tqdm.write(f"\n!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ '{title}': {e}")
                fail_count += 1
                continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏–≥—Ä–µ

    finally:
        fetcher.close()
        conn.close()
        print("\n--- –û—Ç—á–µ—Ç ---")
        print(f"–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count}")
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å/–ø—Ä–æ–ø—É—â–µ–Ω–æ: {fail_count}")
        print("–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å indexer.py –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞.")


if __name__ == "__main__":
    main()

============================================================
FILE PATH: ./static/style.css
============================================================
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}

.main-container {
    max-width: 800px;
    margin: auto;
}

h1, h2, h3 {
    color: #ffffff;
    border-bottom: 1px solid #444;
    padding-bottom: 10px;
}

.container {
    background-color: #1e1e1e;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid #444;
    background-color: #2a2a2a;
    color: #e0e0e0;
    box-sizing: border-box;
}

textarea {
    resize: vertical;
}

button {
    background-color: #3f51b5;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
}

button:hover {
    background-color: #303f9f;
}

.status, .results {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
}

.status.success {
    background-color: #2e7d32;
    color: white;
}

.status.error {
    background-color: #c62828;
    color: white;
}

.results ul {
    list-style-type: none;
    padding: 0;
}

.results li {
    background-color: #2a2a2a;
    padding: 10px 15px;
    margin-bottom: 8px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* --- –ù–û–í–´–ï –°–¢–ò–õ–ò --- */

#stats-container {
    text-align: center;
    font-size: 1.1em;
    padding: 15px;
}

#all-games-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 5px 15px; /* –£–º–µ–Ω—å—à–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è —Å–ø–∏—Å–∫–∞ */
}

.result-item a {
    color: #8c9eff;
    text-decoration: none;
    font-weight: bold;
}

.result-item a:hover {
    text-decoration: underline;
}

.result-item span {
    background-color: #3f51b5;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    min-width: 120px;
    text-align: center;
} 
body {
    font-family: sans-serif;
    background: #121212;
    color: #e0e0e0;
    padding: 20px;
}
.main-container { max-width: 900px; margin: auto; }
.container { background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
h1 { color: #fff; text-align: center; }

/* –°—Ç–∏–ª–∏ –ø–æ–∏—Å–∫–∞ */
.search-bar { display: flex; gap: 10px; }
input[type="text"] {
    flex-grow: 1; padding: 12px; border: 1px solid #444;
    background: #2a2a2a; color: white; border-radius: 4px; font-size: 16px;
}
button {
    padding: 10px 20px; background: #3f51b5; color: white;
    border: none; border-radius: 4px; cursor: pointer; font-size: 16px;
}
button:hover { background: #303f9f; }

/* –ù–û–í–û–ï: –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫ */
.search-options {
    margin-top: 15px; display: flex; gap: 15px; align-items: center; font-size: 0.9em; color: #aaa;
}
.radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
.radio-label input { cursor: pointer; }

/* –°—Ç–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
.result-item {
    background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 6px;
}
.result-header {
    display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;
}
.result-title {
    font-size: 1.2em; color: #8c9eff; text-decoration: none; font-weight: bold;
}
.result-title:hover { text-decoration: underline; }

.result-meta { display: flex; gap: 10px; font-size: 0.8em; }

/* –ë–µ–π–¥–∂–∏ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è */
.badge { padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; }
.badge.summary { background-color: #2e7d32; } /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–∞–º–º–∞—Ä–∏ */
.badge.text { background-color: #555; }       /* –°–µ—Ä—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
.score { color: #aaa; }

.result-snippet {
    font-size: 0.9em; color: #ccc; font-style: italic; line-height: 1.4;
}


/* ======== –°–¢–ò–õ–ò –î–õ–Ø –°–ü–ò–°–ö–ê –í–°–ï–• –ò–ì–† ======== */
#all-games-container h2 {
    text-align: center;
    margin-top: 0;
    border-bottom: 1px solid #444;
    padding-bottom: 10px;
}

#all-games-list {
    max-height: 500px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
    overflow-y: auto;
    padding-right: 10px; /* –ú–µ—Å—Ç–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
}

/* –≠–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –∏–≥—Ä */
.game-item-list {
    background-color: #2a2a2a;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 6px;
    border-left: 3px solid #3f51b5; /* –ê–∫—Ü–µ–Ω—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞ */
}

.game-header-list {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.game-title-list {
    font-weight: bold;
    color: #e0e0e0;
}

.game-meta-list {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ */
.status-indicator, .summary-toggle {
    font-size: 0.8em;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: bold;
    white-space: nowrap; /* –ó–∞–ø—Ä–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ç–µ–∫—Å—Ç–∞ */
}

/* –°—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ */
.status-indicator.indexed {
    background-color: #2e7d32; /* –ó–µ–ª–µ–Ω—ã–π */
    color: white;
}

.status-indicator.not-indexed {
    background-color: #c62828; /* –ö—Ä–∞—Å–Ω—ã–π */
    color: white;
}

/* –°—Ç–∞—Ç—É—Å summary */
.status-indicator.no-summary {
    background-color: #555; /* –°–µ—Ä—ã–π */
    color: #bbb;
}

/* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ Summary */
.summary-toggle {
    background-color: #3f51b5; /* –°–∏–Ω–∏–π */
    color: white;
    cursor: pointer;
    user-select: none; /* –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ */
    transition: background-color 0.2s;
}

.summary-toggle:hover {
    background-color: #303f9f;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ summary */
.summary-content {
    display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    margin-top: 12px;
    padding: 10px;
    background-color: #1a1a1a; /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω–∞ */
    border-radius: 4px;
    font-size: 0.9em;
    color: #ccc;
    line-height: 1.5;
    border-top: 1px solid #444;
    word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
}

/* –ö–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π JS –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∞ */
.summary-content.visible {
    display: block;
}

============================================================
FILE PATH: ./static/index.html
============================================================
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYOA AI Search v3</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="main-container">
        <h1>CYOA Semantic Search (Text + AI Summary)</h1>

        <div class="container" id="stats-container">
            Loading stats...
        </div>

        <div class="container search-container">
            <form id="search-form">
                <!-- ... –≤–∞—à–∞ —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
                <div class="search-bar">
                    <input type="text" id="search-query" placeholder="Describe game: e.g., 'isekai rpg with crafting', '#horror school setting'" required>
                    <button type="submit">Search</button>
                </div>
                <div class="search-options">
                    <label>Search Mode:</label>
                    <label class="radio-label">
                        <input type="radio" name="search-mode" value="mixed" checked> Mixed (Smart)
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="search-mode" value="summary"> Summary Only (Tags/Genre)
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="search-mode" value="text"> Raw Text Only
                    </label>
                </div>
            </form>
        </div>

        <div class="container results-container">
            <div id="search-results"></div>
        </div>

        <!-- ======== –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –°–ü–ò–°–ö–ê –ò–ì–† ======== -->
        <div class="container" id="all-games-container">
            <h2>All Games in Database</h2>
            <div id="all-games-list">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–≥—Ä -->
                <p>Loading game list...</p>
            </div>
        </div>
        <!-- ============================================= -->

    </div>

    <script src="/static/script.js"></script>
</body>
</html>

============================================================
FILE PATH: ./static/script.js
============================================================
document.addEventListener('DOMContentLoaded', () => {
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-query');
    const resultsDiv = document.getElementById('search-results');
    const statsDiv = document.getElementById('stats-container');

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    fetch('/stats').then(r => r.json()).then(data => {
        statsDiv.innerHTML = `
            Total: <b>${data.total}</b> | 
            With Text: <b>${data.with_text}</b> | 
            With AI Summary: <b style="color:#4caf50">${data.with_summary}</b> | 
            Indexed: <b>${data.indexed}</b>
        `;
    });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        const mode = document.querySelector('input[name="search-mode"]:checked').value;

        if (query.length < 2) return;
        resultsDiv.innerHTML = '<p>Searching analyzing semantics...</p>';

        try {
            const res = await fetch(`/api/semantic-search?q=${encodeURIComponent(query)}&mode=${mode}`);
            const data = await res.json();

            if (data.results.length === 0) {
                resultsDiv.innerHTML = `<p>No results found in <b>${mode}</b> mode.</p>`;
                return;
            }

            const html = data.results.map(game => {
                const snippetHtml = game.snippet ? `<div class="result-snippet">AI Summary: "${game.snippet}"</div>` : '';
                const matchClass = game.match_type === 'summary' ? 'summary' : 'text';
                const matchLabel = game.match_type === 'summary' ? 'AI Match' : 'Text Match';

                return `
                    <div class="result-item">
                        <div class="result-header">
                            <a href="${game.url}" target="_blank" class="result-title">${game.title}</a>
                            <div class="result-meta">
                                <span class="badge ${matchClass}">${matchLabel}</span>
                                <span class="score">${game.score}%</span>
                            </div>
                        </div>
                        ${snippetHtml}
                    </div>
                `;
            }).join('');

            resultsDiv.innerHTML = `<p style="color:#888; margin-bottom:10px">Results using <b>${data.mode_used}</b> mode:</p>` + html;
        } catch (err) {
            resultsDiv.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
        }
    });

    // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä ---
    async function loadAllGames() {
        const gamesListDiv = document.getElementById('all-games-list');
        try {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç /games –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const response = await fetch('/games'); 
            const games = await response.json();

            if (games.length === 0) {
                gamesListDiv.innerHTML = '<p>No games found in the database.</p>';
                return;
            }

            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã
            const gamesHtml = games.map((game, index) => {
                const indexedStatus = game.is_indexed
                    ? '<span class="status-indicator indexed">Indexed</span>'
                    : '<span class="status-indicator not-indexed">Not Indexed</span>';
                
                // –ï—Å–ª–∏ summary –µ—Å—Ç—å - —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –º–µ—Ç–∫—É
                const summaryStatus = game.has_summary
                    ? `<span class="summary-toggle" data-target="summary-${index}">Summary</span>`
                    : '<span class="status-indicator no-summary">No Summary</span>';

                // –ï—Å–ª–∏ summary –µ—Å—Ç—å - —Å–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π div —Å –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º
                const summaryContent = game.has_summary
                    ? `<div class="summary-content" id="summary-${index}">${game.summary.replace(/\n/g, '<br>')}</div>`
                    : '';

                return `
                    <div class="game-item-list">
                        <div class="game-header-list">
                            <span class="game-title-list">${game.title}</span>
                            <div class="game-meta-list">
                                ${indexedStatus}
                                ${summaryStatus}
                            </div>
                        </div>
                        ${summaryContent}
                    </div>
                `;
            }).join('');

            gamesListDiv.innerHTML = gamesHtml;

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ "Summary"
            document.querySelectorAll('.summary-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const targetId = toggle.getAttribute('data-target');
                    const summaryContent = document.getElementById(targetId);
                    if (summaryContent) {
                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å 'visible' –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è
                        summaryContent.classList.toggle('visible');
                    }
                });
            });

        } catch (error) {
            gamesListDiv.innerHTML = `<p style="color:red">Error loading game list: ${error.message}</p>`;
        }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadAllGames();
});

============================================================
FILE PATH: ./thrash/111_summarize_project.py
============================================================
# summarize_project.py

import os
import argparse
import fnmatch
from pathlib import Path

try:
    import pathspec
except ImportError:
    print("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'pathspec' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–µ:")
    print("pip install pathspec")
    exit(1)

# –§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–µ–¥—É–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ .gitignore
DEFAULT_IGNORE = [
    ".git",
    "__pycache__",
    ".vscode",
    ".idea",
    "node_modules",
    "venv",
    ".env",
    "dist",
    "build",
    "*.pyc",
    "*.log",
    "*.swp",
    "*.swo",
]

def get_gitignore_spec(project_path: Path):
    """–ù–∞—Ö–æ–¥–∏—Ç –∏ –ø–∞—Ä—Å–∏—Ç .gitignore, –≤–æ–∑–≤—Ä–∞—â–∞—è –æ–±—ä–µ–∫—Ç PathSpec."""
    gitignore_file = project_path / ".gitignore"
    lines = []
    if gitignore_file.is_file():
        with open(gitignore_file, "r", encoding="utf-8") as f:
            lines = f.readlines()
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    lines.extend(f"\n{pattern}" for pattern in DEFAULT_IGNORE)
    
    return pathspec.PathSpec.from_lines("gitwildmatch", lines)

def is_binary(file_path: Path) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –±–∏–Ω–∞—Ä–Ω—ã–º."""
    try:
        with open(file_path, "tr", encoding="utf-8") as f:
            f.read(1024)
        return False
    except UnicodeDecodeError:
        return True
    except Exception:
        return True

def build_tree(project_path: Path, spec: pathspec.PathSpec, prefix: str = "") -> str:
    """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Å—Ç—Ä–æ–∏—Ç –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫."""
    tree_str = ""
    items = sorted(list(project_path.iterdir()), key=lambda p: (p.is_file(), p.name.lower()))
    
    for i, item in enumerate(items):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—É—Ç—å
        relative_path = item.relative_to(project_path.parent)
        if spec.match_file(str(relative_path)):
            continue

        is_last = (i == len(items) - 1)
        connector = "‚îî‚îÄ‚îÄ " if is_last else "‚îú‚îÄ‚îÄ "
        tree_str += f"{prefix}{connector}{item.name}\n"
        
        if item.is_dir():
            new_prefix = prefix + ("    " if is_last else "‚îÇ   ")
            tree_str += build_tree(item, spec, new_prefix)
            
    return tree_str

def main():
    parser = argparse.ArgumentParser(
        description="–°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤ –≤ –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª, —É–≤–∞–∂–∞—è .gitignore."
    )
    parser.add_argument(
        "--path",
        type=str,
        default=".",
        help="–ü—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞."
    )
    parser.add_argument(
        "--output",
        type=str,
        default="111_project_summary.txt",
        help="–ò–º—è –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - project_summary.txt."
    )
    args = parser.parse_args()

    project_path = Path(args.path).resolve()
    output_file = Path(args.output).resolve()

    if not project_path.is_dir():
        print(f"–û—à–∏–±–∫–∞: –£–∫–∞–∑–∞–Ω–Ω—ã–π –ø—É—Ç—å '{project_path}' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π.")
        return

    print(f"–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞: {project_path}")
    print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: {output_file}")

    gitignore_spec = get_gitignore_spec(project_path)
    
    all_files_content = []
    
    # 1. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    print("–°–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞...")
    project_tree = f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:\n{project_path.name}\n"
    project_tree += build_tree(project_path, gitignore_spec)
    
    # 2. –°–±–æ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–æ–≤
    print("–°–±–æ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–æ–≤...")
    for root, _, files in os.walk(project_path):
        root_path = Path(root)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω—É–∂–Ω–æ –ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        relative_dir_path = root_path.relative_to(project_path.parent)
        if gitignore_spec.match_file(str(relative_dir_path)):
            continue
            
        for file in sorted(files):
            file_path = root_path / file
            relative_file_path = file_path.relative_to(project_path)
            
            if gitignore_spec.match_file(str(relative_file_path)):
                continue

            if is_binary(file_path):
                continue
            
            try:
                with open(file_path, "r", encoding="utf-8", errors="ignore") as f:
                    content = f.read()
                
                header = f"--- START FILE: {relative_file_path} ---\n"
                footer = f"\n--- END FILE: {relative_file_path} ---\n"
                all_files_content.append(header + content + footer)
                
            except Exception as e:
                print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª {file_path}: {e}")

    # 3. –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
    print("–ó–∞–ø–∏—Å—å –≤ –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª...")
    try:
        with open(output_file, "w", encoding="utf-8") as f:
            f.write("="*80 + "\n")
            f.write("–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê\n")
            f.write("="*80 + "\n\n")
            f.write(project_tree)
            f.write("\n\n" + "="*80 + "\n")
            f.write("–°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–û–í\n")
            f.write("="*80 + "\n\n")
            f.write("\n\n".join(all_files_content))
        
        print(f"\n–ì–æ—Ç–æ–≤–æ! –í—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª:\n{output_file}")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª {output_file}: {e}")


if __name__ == "__main__":
    main()

============================================================
FILE PATH: ./thrash/111_project_summary.txt
============================================================
================================================================================
–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê
================================================================================

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:
cyoa_embendings
‚îú‚îÄ‚îÄ semantic-search-deploy
‚îú‚îÄ‚îÄ static
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ script.js
‚îÇ   ‚îî‚îÄ‚îÄ style.css
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ clear_database.py
‚îú‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ create_database.py
‚îú‚îÄ‚îÄ fetch_game_text.py
‚îú‚îÄ‚îÄ generate_summary.py
‚îú‚îÄ‚îÄ indexer.py
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ process_static_cyoa.py
‚îú‚îÄ‚îÄ readme
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ reset_index_status.py
‚îú‚îÄ‚îÄ summary_prompt.txt
‚îú‚îÄ‚îÄ sync_with_pocketbase.py
‚îú‚îÄ‚îÄ TODO.md


================================================================================
–°–û–î–ï–†–ñ–ò–ú–û–ï –§–ê–ô–õ–û–í
================================================================================

--- START FILE: .gitignore ---
# –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
venv/

# –ö—ç—à Python
__pycache__/

# –°–µ–∫—Ä–µ—Ç—ã
.env
gcp-credentials.json 

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
*.db
*.index
*.json
*.jsonl

temp_indexer_vertex.py

111_summarize_project.py
111_project_summary.txt



# –õ–æ–≥-—Ñ–∞–π–ª—ã
*.log

todo

semantic-search-deploy/
--- END FILE: .gitignore ---


--- START FILE: TODO.md ---
# –ü–ª–∞–Ω –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞ CYOA Embeddings

 

## 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 2.1. –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤

-   **–ü—Ä–æ–±–ª–µ–º–∞:** `fetch_game_text.py` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–≥—Ä—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. –ó–∞–≥—Ä—É–∑–∫–∞ `project.json` ‚Äî —ç—Ç–æ I/O-–æ–ø–µ—Ä–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏—é.
-   **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `concurrent.futures.ThreadPoolExecutor` –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ `project.json` –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–≥—Ä. –ó–∞–ø—É—Å–∫ Selenium –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º—É, –∏–ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –µ–≥–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö –∏–≥—Ä, –≥–¥–µ –ø—Ä—è–º–æ–π –º–µ—Ç–æ–¥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª.

### 2.2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

-   **–ü—Ä–æ–±–ª–µ–º–∞:** `indexer.py` –≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤—Å–µ—Ö –∏–≥—Ä. –≠—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∏–≥—Ä–∞.
-   **–†–µ—à–µ–Ω–∏–µ:** –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `indexer.py` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:
    1.  –î–æ–±–∞–≤–∏—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç `--incremental` –∏–ª–∏ `--since <timestamp>`.
    2.  –í—ã–±–∏—Ä–∞—Ç—å –∏–∑ –ë–î —Ç–æ–ª—å–∫–æ —Ç–µ –∏–≥—Ä—ã, –≥–¥–µ `last_indexed_at` IS NULL (–Ω–æ–≤—ã–µ/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ).
    3.  –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Faiss-–∏–Ω–¥–µ–∫—Å –∏ –∫–∞—Ä—Ç—É —á–∞–Ω–∫–æ–≤.
    4.  –£–¥–∞–ª—è—Ç—å –∏–∑ –∏–Ω–¥–µ–∫—Å–∞ —Å—Ç–∞—Ä—ã–µ –≤–µ–∫—Ç–æ—Ä—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º –∏–≥—Ä–∞–º (–ø–æ `game_id`). –≠—Ç–æ —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å, —Ç—Ä–µ–±—É—é—â–∞—è `index.remove_ids()`.
    5.  –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–∏—Ö –∏–≥—Ä.
    *–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ, –ø–æ—ç—Ç–æ–º—É —ç—Ç—É –∑–∞–¥–∞—á—É —Å—Ç–æ–∏—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π.*

## 3. –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### 3.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `main.py` –≤–∫–ª—é—á–∞–µ—Ç—Å—è/–≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `DEBUG_LOGGING`. –õ–æ–≥–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö –≤—ã–≤–æ–¥—è—Ç—Å—è —á–µ—Ä–µ–∑ `print()` –∏–ª–∏ `tqdm.write()`.
-   **–†–µ—à–µ–Ω–∏–µ:** –í–Ω–µ–¥—Ä–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É `logging` –≤–æ –≤—Å–µ —Å–∫—Ä–∏–ø—Ç—ã. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (INFO, WARNING, ERROR) –∏ –≤—ã–≤–æ–¥–∏—Ç—å –∏—Ö –≤ –∫–æ–Ω—Å–æ–ª—å –∏/–∏–ª–∏ —Ñ–∞–π–ª. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –≤—ã–≤–æ–¥–∞.

### 3.2. –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ API

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –í `generate_summary.py` –æ—à–∏–±–∫–∞ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ `"API_ERROR: ..."`. –≠—Ç–æ –Ω–µ –æ—á–µ–Ω—å –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±.
-   **–†–µ—à–µ–Ω–∏–µ:** –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `generate_summary_with_openrouter` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–ª–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (raise Exception) –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏. –í –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ `process_game` –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤—ã–∑–æ–≤ –≤ `try...except` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ—Ä—Ç–µ–∂ `(pb_id, title, None, error_message)`. –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –±–æ–ª–µ–µ —è–≤–Ω–æ–π.

## 4. –£–ª—É—á—à–µ–Ω–∏—è Frontend

### 4.1. –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –≤ –±–∞–∑–µ –±—É–¥—É—Ç —Ç—ã—Å—è—á–∏ –∏–≥—Ä, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "All Games" —Å—Ç–∞–Ω–µ—Ç –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–π –∏ –≥—Ä–æ–º–æ–∑–¥–∫–æ–π, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ –∏–≥—Ä—ã —Å—Ä–∞–∑—É.
-   **–†–µ—à–µ–Ω–∏–µ:**
    1.  –ù–∞ –±—ç–∫–µ–Ω–¥–µ (`main.py` –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ `/games`) –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `page` –∏ `page_size` –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
    2.  –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (`static/script.js`) —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å "–±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É" (infinite scroll) –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ", –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Ä—Ü–∏—é –∏–≥—Ä –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

### 4.2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

-   **–ü—Ä–æ–±–ª–µ–º–∞:** –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å.
-   **–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª–µ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞ —Ç–∞–∫–∂–µ —Ñ–∏–ª—å—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–¢–æ–ª—å–∫–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º", "–ù–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ") –∏ –æ–ø—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É, –ø–æ –¥–∞—Ç–µ). –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è –Ω–∞ –±—ç–∫–µ–Ω–¥.

---

--- END FILE: TODO.md ---


--- START FILE: clear_database.py ---
# clear_database.py
import sqlite3
import os
import config

def clear_all_games():
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã 'games', –Ω–µ —É–¥–∞–ª—è—è —Å–∞–º—É —Ç–∞–±–ª–∏—Ü—É."""
    if not os.path.exists(config.DB_FILE):
        print(f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{config.DB_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ—á–µ–≥–æ –æ—á–∏—â–∞—Ç—å.")
        return

    try:
        conn = sqlite3.connect(config.DB_FILE)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        cursor.execute("SELECT COUNT(*) FROM games")
        count_before = cursor.fetchone()[0]

        if count_before == 0:
            print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –ø—É—Å—Ç–∞.")
            conn.close()
            return
            
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        confirm = input(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å {count_before} –∏–≥—Ä –∏–∑ –±–∞–∑—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. (y/n): ")
        
        if confirm.lower() == 'y':
            print("–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π...")
            # –ì–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã games
            cursor.execute("DELETE FROM games")
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã ID —Å–Ω–æ–≤–∞ –Ω–∞—á–∏–Ω–∞–ª–∏—Å—å —Å 1
            cursor.execute("DELETE FROM sqlite_sequence WHERE name='games'")
            conn.commit()
            print("–í—Å–µ –∏–≥—Ä—ã –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞.")
        else:
            print("–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

        conn.close()
        
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    clear_all_games()
--- END FILE: clear_database.py ---


--- START FILE: config.py ---
# config.py

"""
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.
–í—Å–µ –æ–±—â–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∑–¥–µ—Å—å.
"""

# --- –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º ---
DB_FILE = "games.db"
INDEX_FILE = "games.index"
MAPPING_FILE = "chunk_map.json"
SUMMARY_PROMPT_FILE = "summary_prompt.txt"

# --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ---
DEBUG_LOGGING = False # –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ main.py
LOG_FILE = "search_debug.log"
QUERY_LOG_FILE = "user_queries.jsonl"

# --- –ú–æ–¥–µ–ª–∏ ---
EMBEDDING_MODEL_NAME = "gemini-embedding-001"
GENERATION_MODEL_NAME = "deepseek/deepseek-v3.2-exp"

# --- API –∏ –°–µ—Ä–≤–∏—Å—ã ---
BASE_GAME_URL = "https://cyoa.cafe/game/"

# --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ ---
OUTPUT_DIMENSION = 256
BATCH_SIZE = 100
API_REQUEST_DELAY = 3 # –ü–∞—É–∑–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –º–µ–∂–¥—É API –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤ indexer.py
MAX_RETRIES = 3

# --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –≤ main.py ---
SUMMARY_WEIGHT = 0.70 
TEXT_WEIGHT = 0.30    
DECAY_FACTOR = 0.85 
--- END FILE: config.py ---


--- START FILE: create_database.py ---
# create_database.py
import sqlite3
import os

DB_FILE = "games.db"

def create_database():
    """–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∞–±–ª–∏—Ü—É 'games' —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π."""
    if os.path.exists(DB_FILE):
        print(f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{DB_FILE}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        print("–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É, —É–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é.")
        return

    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        cursor.execute('''
        CREATE TABLE games (
            pocketbase_id TEXT PRIMARY KEY,
            title TEXT NOT NULL,
            original_url TEXT, -- –î–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö CYOA (iframe_url)
            image_urls TEXT,   -- –ù–û–í–û–ï –ü–û–õ–ï: –¥–ª—è JSON-—Å–ø–∏—Å–∫–∞ URL-–æ–≤ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA
            full_text TEXT,
            summary TEXT,
            source_hash TEXT,
            last_indexed_at TIMESTAMP,
            is_indexed BOOLEAN DEFAULT 0
        )
        ''')

        conn.commit()
        conn.close()
        print(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö '{DB_FILE}' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ —Å –∫–æ–ª–æ–Ω–∫–æ–π 'image_urls'.")

    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")

if __name__ == "__main__":
    # –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º –Ω–æ–≤—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤, —É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π games.db
    # –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –±–∞–∑—É —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.
    create_database()
--- END FILE: create_database.py ---


--- START FILE: fetch_game_text.py ---
# fetch_game_text.py (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
import os
import re
import json
import sqlite3
import time
import requests
from urllib.parse import urljoin
from tqdm import tqdm
import chardet

from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –§—É–Ω–∫—Ü–∏—è json_to_text –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
def json_to_text(data):
    # ... (–∫–æ–¥ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è)
    texts = []
    if not isinstance(data, dict): return ""
    if 'rows' in data:
        for row in data.get('rows', []):
            if isinstance(row, dict):
                if row.get('titleText'): texts.append(row['titleText'])
                for obj in row.get('objects', []):
                     if isinstance(obj, dict) and obj.get('text'): texts.append(obj['text'])
    elif 'sections' in data:
        for section in data.get('sections', []):
            if isinstance(section, dict):
                if section.get('title'): texts.append(section['title'])
                if section.get('text'): texts.append(section['text'])
    elif 'content' in data:
         texts.append(data.get('content', ''))
    return "\n\n".join(filter(None, texts))

# --- –ö–ª–∞—Å—Å GameTextFetcher –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ—á—Ç–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
class GameTextFetcher: 
    def __init__(self):
        self.session = requests.Session()
        self.driver = None
        self.js_json_pattern = re.compile(r'Store\(\{state:\{app:(.*?)\},getters:', re.DOTALL)
    def _init_driver(self):
        if self.driver is None:
            print("    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è headless-–±—Ä–∞—É–∑–µ—Ä–∞ (Selenium)...")
            options = Options()
            options.add_argument('--headless'); options.add_argument('--disable-gpu'); options.add_argument('--log-level=3')
            options.set_capability('goog:loggingPrefs', {'performance': 'ALL'})
            try:
                self.driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
            except Exception as e:
                print(f"    –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å WebDriver: {e}"); raise
    def _try_direct_project_json(self, base_url):
        """–°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: –ü—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —Å–∫–∞—á–∞—Ç—å project.json —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏."""
        project_url = urljoin(base_url, 'project.json')
        try:
            with self.session.get(project_url, timeout=60, stream=True) as response:
                if response.status_code == 200:
                    content_length = response.headers.get('content-length')
                    size_info = f"({int(content_length) / 1024 / 1024:.2f} MB)" if content_length else ""
                    print(f"    [OK] –ù–∞–π–¥–µ–Ω project.json. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É {size_info}...")
                    
                    content = response.content
                    
                    # --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ---
                    # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫—É —Å –ø–æ–º–æ—â—å—é chardet
                    detected_encoding = chardet.detect(content)['encoding']
                    if not detected_encoding:
                        detected_encoding = 'utf-8' # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    print(f"    [INFO] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∞: {detected_encoding}")
                    
                    # 2. –î–µ–∫–æ–¥–∏—Ä—É–µ–º –±–∞–π—Ç—ã –≤ —Å—Ç—Ä–æ–∫—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
                    text_content = content.decode(detected_encoding, errors='replace')
                    
                    # 3. –ü–∞—Ä—Å–∏–º —É–∂–µ —Å—Ç—Ä–æ–∫—É, –∞ –Ω–µ –±–∞–π—Ç—ã
                    json_data = json.loads(text_content)
                    
                    print(f"    [OK] project.json —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω.")
                    return json_data
        except requests.exceptions.Timeout:
            print(f"    [FAIL] –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ {project_url}."); return None
        except requests.RequestException as e:
            print(f"    [INFO] –ó–∞–ø—Ä–æ—Å –∫ project.json –Ω–µ —É–¥–∞–ª—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, –µ–≥–æ –Ω–µ—Ç): {e.__class__.__name__}"); return None
        except json.JSONDecodeError:
            print(f"    [FAIL] –§–∞–π–ª project.json —Å–∫–∞—á–∞–Ω, –Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON."); return None
        except UnicodeDecodeError as e:
            print(f"    [FAIL] –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞, –¥–∞–∂–µ –ø–æ—Å–ª–µ chardet: {e}")
            return None
        return None
    def _try_selenium_extraction(self, game_url):
        self._init_driver()
        self.driver.get(game_url)
        time.sleep(7)
        logs = self.driver.get_log('performance')
        json_urls, js_urls = set(), set()
        for log in logs:
            try:
                message = json.loads(log['message'])['message']
                if message['method'] == 'Network.responseReceived':
                    url = message['params']['response']['url']
                    if url.endswith('.json'): json_urls.add(url)
                    elif url.endswith('.js'): js_urls.add(url)
            except (KeyError, json.JSONDecodeError): continue
        if json_urls:
            print(f"    [INFO] –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞: –Ω–∞–π–¥–µ–Ω–æ {len(json_urls)} JSON-—Ñ–∞–π–ª–æ–≤.")
            for url in json_urls:
                try:
                    response = self.session.get(url, timeout=30)
                    if response.status_code == 200:
                        print(f"    [OK] –£—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω JSON –∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞: {os.path.basename(url)}"); return response.json()
                except requests.RequestException: continue
        if js_urls:
            print(f"    [INFO] –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑: –Ω–∞–π–¥–µ–Ω–æ {len(js_urls)} JS-—Ñ–∞–π–ª–æ–≤.")
            for url in js_urls:
                try:
                    response = self.session.get(url, timeout=30)
                    if response.status_code != 200: continue
                    match = self.js_json_pattern.search(response.text)
                    if match:
                        json_str = match.group(1).strip()
                        print(f"    [OK] –ù–∞–π–¥–µ–Ω—ã –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ JS-—Ñ–∞–π–ª–µ: {os.path.basename(url)}"); return json.loads(json_str)
                except (requests.RequestException, json.JSONDecodeError): continue
        return None
    def fetch(self, game_url):
        if game_url.endswith('index.html'): game_url = game_url[:-10]
        print("  - –ü–æ–ø—ã—Ç–∫–∞ 1: –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ project.json...")
        json_data = self._try_direct_project_json(game_url)
        if json_data:
            text = json_to_text(json_data)
            if text: print("    [SUCCESS] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω –∏–∑ project.json!"); return text
            else: print("    [WARN] project.json –Ω–∞–π–¥–µ–Ω, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–Ω–∞–ª–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã...")
        print("  - –ü–æ–ø—ã—Ç–∫–∞ 2: –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ Selenium...")
        try:
            json_data_selenium = self._try_selenium_extraction(game_url)
            if json_data_selenium:
                text = json_to_text(json_data_selenium)
                if text: print("    [SUCCESS] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã!"); return text
                else: print("    [WARN] –î–∞–Ω–Ω—ã–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—É—á–µ–Ω—ã, –Ω–æ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–µ–∫—Å—Ç–∞.")
        except Exception as e:
            print(f"    [ERROR] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ Selenium: {e}"); return None
        print("    [FAIL] –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –Ω–∏ –æ–¥–Ω–∏–º –∏–∑ –º–µ—Ç–æ–¥–æ–≤."); return None
    def close(self):
        if self.driver: print("–ó–∞–∫—Ä—ã—Ç–∏–µ headless-–±—Ä–∞—É–∑–µ—Ä–∞..."); self.driver.quit(); self.driver = None


def main():
    """
    –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å: –Ω–∞–π—Ç–∏ –∏–≥—Ä—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–ª—è –Ω–∏—Ö Fetcher.
    """
    conn = sqlite3.connect(config.DB_FILE)
    cursor = conn.cursor()

    # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–µ–ø–µ—Ä—å –º—ã –≤—ã–±–∏—Ä–∞–µ–º –∏ original_url
    cursor.execute("SELECT pocketbase_id, title, original_url FROM games WHERE full_text IS NULL OR full_text = ''")
    games_to_process = cursor.fetchall()

    if not games_to_process:
        print("–í—Å–µ –∏–≥—Ä—ã —É–∂–µ –∏–º–µ—é—Ç —Ç–µ–∫—Å—Ç. –ù–µ—á–µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.")
        conn.close()
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(games_to_process)} –∏–≥—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.")
    
    fetcher = GameTextFetcher()
    success_count = 0
    fail_count = 0
    
    try:
        # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í —Ü–∏–∫–ª–µ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∏ original_url
        for pb_id, title, original_url in tqdm(games_to_process, desc="–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–≥—Ä"):
            
            # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞. –ï—Å–ª–∏ URL –Ω–µ—Ç, –º—ã –Ω–µ –º–æ–∂–µ–º –Ω–∏—á–µ–≥–æ —Å–¥–µ–ª–∞—Ç—å.
            try:
                if not original_url:
                    tqdm.write(f"\n-> [SKIP] –ü—Ä–æ–ø—É—Å–∫ '{title}', —Ç–∞–∫ –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.")
                    fail_count += 1
                    continue

                tqdm.write(f"\n-> –û–±—Ä–∞–±–æ—Ç–∫–∞: '{title}' ({original_url})")
                
                text_content = fetcher.fetch(original_url)

                if text_content:
                    cursor.execute(
                        "UPDATE games SET full_text = ? WHERE pocketbase_id = ?",
                        (text_content, pb_id)
                    )
                    conn.commit()
                    success_count += 1
                else:
                    fail_count += 1
            except Exception as e:
                # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
                tqdm.write(f"\n!!! –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ '{title}': {e}")
                fail_count += 1
                continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏–≥—Ä–µ

    finally:
        fetcher.close()
        conn.close()
        print("\n--- –û—Ç—á–µ—Ç ---")
        print(f"–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {success_count}")
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å/–ø—Ä–æ–ø—É—â–µ–Ω–æ: {fail_count}")
        print("–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å indexer.py –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞.")


if __name__ == "__main__":
    main()
--- END FILE: fetch_game_text.py ---


--- START FILE: generate_summary.py ---
# generate_summary.py
import sqlite3
import os
import argparse
import concurrent.futures
from dotenv import load_dotenv
from openai import OpenAI
from tqdm import tqdm
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
if not OPENROUTER_API_KEY:
    raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω OPENROUTER_API_KEY –≤ .env —Ñ–∞–π–ª–µ")

def load_prompt():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞."""
    if not os.path.exists(config.SUMMARY_PROMPT_FILE):
        raise FileNotFoundError(f"–ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª –ø—Ä–æ–º–ø—Ç–∞: {config.SUMMARY_PROMPT_FILE}")
    with open(config.SUMMARY_PROMPT_FILE, 'r', encoding='utf-8') as f:
        return f.read().strip()

# <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–∏–ª–∏ 'game_title' –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫ --->
def generate_summary_with_openrouter(client, model_name, base_prompt, game_title, game_text):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏–≥—Ä—ã –≤ OpenRouter –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ."""
    try:
        # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–º–µ–Ω—å—à–∞–µ–º –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –≤–ø–∏—Å–∞—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –º–æ–¥–µ–ª–∏ --->
        # –õ–∏–º–∏—Ç –º–æ–¥–µ–ª–∏ ~163k —Ç–æ–∫–µ–Ω–æ–≤. 500k —Å–∏–º–≤–æ–ª–æ–≤ —ç—Ç–æ ~125k —Ç–æ–∫–µ–Ω–æ–≤, —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.
        max_chars = 500000
        
        if len(game_text) > max_chars:
             # –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω
             tqdm.write(f"  [INFO] –¢–µ–∫—Å—Ç –¥–ª—è '{game_title}' —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ({len(game_text)} —Å–∏–º–≤.), –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –¥–æ {max_chars}.")
        
        truncated_text = game_text[:max_chars]
        
        response = client.chat.completions.create(
            model=model_name,
            messages=[
                {
                    "role": "system",
                    "content": base_prompt
                },
                {
                    "role": "user",
                    "content": f"Input Game Text:\n{truncated_text}"
                }
            ],
            temperature=0.2,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –µ–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        return f"API_ERROR: {e}"

def process_game(game_data, client, model_name, base_prompt):
    """
    –§—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–¥–Ω–æ–π –∏–≥—Ä—ã. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ.
    """
    pb_id, title, full_text = game_data
    # <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º 'title' –≤ —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ --->
    summary = generate_summary_with_openrouter(client, model_name, base_prompt, title, full_text)
    return pb_id, title, summary

def run_summary_generation(limit=None, workers=5):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π. –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤.
    """
    base_prompt = load_prompt()
    client = OpenAI(
      base_url="https://openrouter.ai/api/v1",
      api_key=OPENROUTER_API_KEY,
    )

    conn = sqlite3.connect(config.DB_FILE)
    cursor = conn.cursor()

    query = """
        SELECT pocketbase_id, title, full_text 
        FROM games 
        WHERE full_text IS NOT NULL AND full_text != '' AND (summary IS NULL OR summary = '')
    """
    
    params = ()
    if limit:
        query += " LIMIT ?"
        params = (limit,)
        print(f"--- –†–µ–∂–∏–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ –±–æ–ª–µ–µ {limit} –∏–≥—Ä ---")

    cursor.execute(query, params)
    games_to_process = cursor.fetchall()

    if not games_to_process:
        print("–ù–µ—Ç –∏–≥—Ä, —Ç—Ä–µ–±—É—é—â–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è.")
        conn.close()
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(games_to_process)} –∏–≥—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π —Å –ø–æ–º–æ—â—å—é {config.GENERATION_MODEL_NAME} —á–µ—Ä–µ–∑ OpenRouter.")
    print(f"–ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ {workers} –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤...")
    
    success_count = 0
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=workers) as executor:
        future_to_game = {
            executor.submit(process_game, game, client, config.GENERATION_MODEL_NAME, base_prompt): game
            for game in games_to_process
        }
        
        progress_bar = tqdm(concurrent.futures.as_completed(future_to_game), total=len(games_to_process), desc="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π")
        
        for future in progress_bar:
            pb_id, title, summary = future.result()
            
            if summary and not summary.startswith("API_ERROR:"):
                cursor.execute(
                    "UPDATE games SET summary = ?, last_indexed_at = NULL WHERE pocketbase_id = ?",
                    (summary, pb_id)
                )
                conn.commit()
                success_count += 1
            else:
                tqdm.write(f"\n[FAIL] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è '{title}'. –û—à–∏–±–∫–∞: {summary}")

    conn.close()
    print(f"\n–ó–∞–≤–µ—Ä—à–µ–Ω–æ. –£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–π: {success_count}/{len(games_to_process)}.")
    if success_count > 0:
        print("–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏—Ç–µ 'python indexer.py', —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –≤ –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å.")

def main():
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é. –ü–∞—Ä—Å–∏—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.
    """
    parser = argparse.ArgumentParser(description="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ–ø–∏—Å–∞–Ω–∏–π –∏–≥—Ä —Å –ø–æ–º–æ—â—å—é OpenRouter.")
    parser.add_argument('--limit', type=int, default=None, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫.")
    parser.add_argument('--workers', type=int, default=5, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API.")
    args = parser.parse_args()
    run_summary_generation(limit=args.limit, workers=args.workers)

if __name__ == "__main__":
    main()
--- END FILE: generate_summary.py ---


--- START FILE: indexer.py ---
# indexer.py (–í–µ—Ä—Å–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Summary –∏ –ø–∞—É–∑–æ–π –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)
import json
import os
import numpy as np
import faiss
import google.generativeai as genai
import argparse
import sqlite3
import time
from dotenv import load_dotenv
from tqdm import tqdm
from datetime import datetime
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
if not GOOGLE_API_KEY:
    raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω GOOGLE_API_KEY –≤ .env —Ñ–∞–π–ª–µ")
genai.configure(api_key=GOOGLE_API_KEY)

def chunk_raw_text(text, chunk_size=500, overlap=50):
    """–†–∞–∑–±–∏–≤–∞–µ—Ç —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –∏–≥—Ä—ã –Ω–∞ —á–∞–Ω–∫–∏."""
    words = text.split()
    if not words: return []
    chunks = []
    start = 0
    while start < len(words):
        end = start + chunk_size
        chunk_words = words[start:end]
        chunks.append(" ".join(chunk_words))
        if end >= len(words): break
        start += chunk_size - overlap
    return chunks

def generate_embeddings_in_batches(texts):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –±–∞—Ç—á–∞–º–∏."""
    all_embeddings = []
    successful_indices = []
    
    if not texts: return [], []

    num_batches = (len(texts) + config.BATCH_SIZE - 1) // config.BATCH_SIZE
    for i in tqdm(range(0, len(texts), config.BATCH_SIZE), total=num_batches, desc="API Gemini (Embeddings)"):
        batch_texts = texts[i:i + config.BATCH_SIZE]
        retries = 0
        success = False
        while retries < config.MAX_RETRIES:
            try:
                result = genai.embed_content(
                    model=f"models/{config.EMBEDDING_MODEL_NAME}",
                    content=batch_texts,
                    task_type="RETRIEVAL_DOCUMENT",
                    output_dimensionality=config.OUTPUT_DIMENSION
                )
                # Gemini –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å None –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –≤ –±–∞—Ç—á–µ, –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞—é—Ç —Ñ–∏–ª—å—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                embeddings = result.get('embedding', [])
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω—É–≤—à–∏—Ö—Å—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º
                if len(embeddings) != len(batch_texts):
                    # –≠—Ç–æ —Å–ª–æ–∂–Ω—ã–π –∫–µ–π—Å, –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –ø—Ä–æ–ø—É—Å—Ç–∏–º –±–∞—Ç—á
                    print(f"\n–í–Ω–∏–º–∞–Ω–∏–µ: Gemini –≤–µ—Ä–Ω—É–ª {len(embeddings)} –≤–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è {len(batch_texts)} —Ç–µ–∫—Å—Ç–æ–≤. –ë–∞—Ç—á –ø—Ä–æ–ø—É—â–µ–Ω.")
                    break

                all_embeddings.extend(embeddings)
                successful_indices.extend(range(i, i + len(embeddings)))
                success = True
                break
            except Exception as e:
                retries += 1
                print(f"\n–û—à–∏–±–∫–∞ –±–∞—Ç—á–∞ {i} (–ø–æ–ø—ã—Ç–∫–∞ {retries}): {e}")
                time.sleep(2 * retries)
        
        if not success:
             # –ó–∞–ø–æ–ª–Ω—è–µ–º None, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é —Å–ø–∏—Å–∫–∞ texts
             all_embeddings.extend([None] * len(batch_texts))

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—à–∞—Ç—å –ª–∏–º–∏—Ç—ã API.
        # –ù–µ–±–æ–ª—å—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ –∂–¥–µ–º –ø–æ—Å–ª–µ —Å–∞–º–æ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ç—á–∞.
        if i + config.BATCH_SIZE < len(texts):
            time.sleep(config.API_REQUEST_DELAY)

    return all_embeddings, successful_indices

def main(full_reindex=False):
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.
    :param full_reindex: –ï—Å–ª–∏ True, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.
                         –ï—Å–ª–∏ False (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.
    """
    is_incremental = not full_reindex

    conn = sqlite3.connect(config.DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    if is_incremental and os.path.exists(config.INDEX_FILE):
        print("--- –†–µ–∂–∏–º: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ---")
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∏–≥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –±—ã–ª–∏ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
        cursor.execute("""
            SELECT pocketbase_id, title, full_text, summary 
            FROM games 
            WHERE last_indexed_at IS NULL 
            AND ((full_text IS NOT NULL AND full_text != '') OR (summary IS NOT NULL AND summary != ''))
        """)
    else:
        if is_incremental:
            print("–§–∞–π–ª –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è.")
        else:
            print("--- –†–µ–∂–∏–º: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ---")
        full_reindex = True # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –ø–æ–ª–Ω—ã–π —Ä–µ–∂–∏–º
        is_incremental = False
        # –ë–µ—Ä–µ–º –í–°–ï –∏–≥—Ä—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Å–∞–º–º–∞—Ä–∏)
        cursor.execute("""
            SELECT pocketbase_id, title, full_text, summary 
            FROM games 
            WHERE (full_text IS NOT NULL AND full_text != '') OR (summary IS NOT NULL AND summary != '')
        """)

    all_games = cursor.fetchall()

    if not all_games:
        print("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–≥—Ä –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.")
        if is_incremental:
            print("–í—Å–µ –∏–≥—Ä—ã —É–∂–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã.")
        conn.close()
        return

    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(all_games)} –∏–≥—Ä. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —á–∞–Ω–∫–æ–≤...")

    texts_to_embed = []
    temp_chunk_map = [] # –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

    # –ï—Å–ª–∏ —ç—Ç–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –Ω–∞–º –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —á–∞–Ω–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª—è–µ–º—ã—Ö –∏–≥—Ä
    if is_incremental:
        game_ids_to_update = {game['pocketbase_id'] for game in all_games}
        print(f"–ë—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è {len(game_ids_to_update)} –∏–≥—Ä.")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ ID –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        with open(config.MAPPING_FILE, 'r', encoding='utf-8') as f:
            old_chunk_map = {int(k): v for k, v in json.load(f).items()}
        
        ids_to_remove = [
            faiss_id for faiss_id, meta in old_chunk_map.items() 
            if meta['game_id'] in game_ids_to_update
        ]
        
        if ids_to_remove:
            print(f"–ù–∞–π–¥–µ–Ω–æ {len(ids_to_remove)} —Å—Ç–∞—Ä—ã—Ö —á–∞–Ω–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–Ω–¥–µ–∫—Å–∞.")
            # Faiss –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ IndexFlatIP.
            # –ü—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ —Å–¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.
            print("–í–Ω–∏–º–∞–Ω–∏–µ: –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–≥—Ä—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è.")
            full_reindex = True
            return main(full_reindex=True) # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

    for game in tqdm(all_games, desc="–ß–∞–Ω–∫–∏–Ω–≥"):
        game_id = game['pocketbase_id']
        game_title = game['title']
        
        # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ SUMMARY (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if game['summary']:
            # –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π, –≤–∞–∂–Ω—ã–π —á–∞–Ω–∫.
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ —Å–∞–º —Ç–µ–∫—Å—Ç –¥–ª—è –ª—É—á—à–µ–π —Å–µ–º–∞–Ω—Ç–∏–∫–∏.
            enriched_summary = f"Summary/Description of CYOA game '{game_title}': {game['summary']}"
            texts_to_embed.append(enriched_summary)
            temp_chunk_map.append({
                "game_id": game_id,
                "type": "summary", # –ú–µ—Ç–∫–∞ —Ç–∏–ø–∞
                "text_snippet": game['summary'][:300] + "..." # –î–ª—è –¥–µ–±–∞–≥–∞ –≤ JSON
            })

        # 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ FULL_TEXT (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if game['full_text']:
            raw_chunks = chunk_raw_text(game['full_text'])
            for chunk in raw_chunks:
                enriched_chunk = f"Text excerpt from CYOA game '{game_title}': {chunk}"
                texts_to_embed.append(enriched_chunk)
                temp_chunk_map.append({
                    "game_id": game_id,
                    "type": "text", # –ú–µ—Ç–∫–∞ —Ç–∏–ø–∞
                    "text_snippet": chunk[:200] + "..."
                })

    print(f"–í—Å–µ–≥–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ {len(texts_to_embed)} —á–∞–Ω–∫–æ–≤ (Summary + Text).")

    # --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ ---
    raw_embeddings, successful_indices = generate_embeddings_in_batches(texts_to_embed)

    if not successful_indices:
        print("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏.")
        conn.close()
        return

    # --- –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ Faiss ---
    new_embeddings = [raw_embeddings[i] for i in successful_indices if raw_embeddings[i] is not None]
    embeddings_np = np.array(new_embeddings).astype('float32')
    print("–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤ (L2) –¥–ª—è Cosine Similarity...")
    faiss.normalize_L2(embeddings_np)

    if full_reindex:
        print(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ IndexFlatIP –¥–ª—è {len(embeddings_np)} –≤–µ–∫—Ç–æ—Ä–æ–≤...")
        index = faiss.IndexFlatIP(config.OUTPUT_DIMENSION)
        index.add(embeddings_np)
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É —á–∞–Ω–∫–æ–≤
        final_chunk_map = {}
        successful_chunks = [temp_chunk_map[i] for i in successful_indices if raw_embeddings[i] is not None]
        for i, chunk_meta in enumerate(successful_chunks):
            final_chunk_map[i] = chunk_meta
    else: # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
        print("–ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...")
        index = faiss.read_index(config.INDEX_FILE)
        with open(config.MAPPING_FILE, 'r', encoding='utf-8') as f:
            final_chunk_map = {int(k): v for k, v in json.load(f).items()}

        start_id = index.ntotal
        print(f"–ò–Ω–¥–µ–∫—Å —Å–æ–¥–µ—Ä–∂–∏—Ç {start_id} –≤–µ–∫—Ç–æ—Ä–æ–≤. –î–æ–±–∞–≤–ª—è–µ–º {len(embeddings_np)} –Ω–æ–≤—ã—Ö...")
        index.add(embeddings_np)

        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –∫–∞—Ä—Ç—É
        successful_chunks = [temp_chunk_map[i] for i in successful_indices if raw_embeddings[i] is not None]
        for i, chunk_meta in enumerate(successful_chunks):
            final_chunk_map[start_id + i] = chunk_meta

    # --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---
    print("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∏ –∫–∞—Ä—Ç—ã...")
    faiss.write_index(index, config.INDEX_FILE)
    with open(config.MAPPING_FILE, 'w', encoding='utf-8') as f:
        json.dump(final_chunk_map, f, ensure_ascii=False, indent=2)

    # --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î ---
    # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ç–µ—Ö –∏–≥—Ä, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –≤ —ç—Ç–æ–º –∑–∞–ø—É—Å–∫–µ
    processed_game_ids = {game['pocketbase_id'] for game in all_games}
    if processed_game_ids:
        current_time = datetime.now().isoformat()
        placeholders = ', '.join('?' for _ in processed_game_ids)
        cursor.execute(
            f"UPDATE games SET last_indexed_at = ? WHERE pocketbase_id IN ({placeholders})",
            (current_time, *processed_game_ids)
        )
        conn.commit()
        print(f"–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è {len(processed_game_ids)} –∏–≥—Ä.")

    # --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ –ë–î ---
    print("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...")
    processed_game_ids = set([info['game_id'] for info in final_chunk_map.values()])
    
    if processed_game_ids:
        current_time = datetime.now().isoformat()
        placeholders = ', '.join('?' for _ in processed_game_ids)
        cursor.execute(
            f"UPDATE games SET last_indexed_at = ? WHERE pocketbase_id IN ({placeholders})",
            (current_time, *processed_game_ids)
        )
        conn.commit()
        print(f"–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è {len(processed_game_ids)} –∏–≥—Ä.")

    conn.close()
    print("\n--- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ---")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="–ò–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–π –∏–≥—Ä –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞.")
    parser.add_argument(
        '--full',
        action='store_true',
        help="–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö, —É–¥–∞–ª–∏–≤ —Å—Ç–∞—Ä—ã–π –∏–Ω–¥–µ–∫—Å."
    )
    args = parser.parse_args()
    main(full_reindex=args.full)
--- END FILE: indexer.py ---


--- START FILE: main.py ---
# main.py (–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–º —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú –ó–ê–ü–†–û–°–û–í)
import os
import json
import numpy as np
import faiss
import google.generativeai as genai
import sqlite3
from dotenv import load_dotenv
from fastapi import FastAPI, HTTPException, Query
from fastapi.staticfiles import StaticFiles, Depends
from fastapi.responses import FileResponse
from typing import List, Dict, Any
from enum import Enum
from collections import defaultdict
from datetime import datetime # <--- –ù–û–í–´–ô –ò–ú–ü–û–†–¢
import math
import logging
from fastapi.middleware.cors import CORSMiddleware 
# --- –ù–û–í–´–ô –ò–ú–ü–û–†–¢: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
import config

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
genai.configure(api_key=GOOGLE_API_KEY)

# --- –°–ï–ö–¶–ò–Ø: –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ---
# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–∫–ª—é—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ ---
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–≥–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
if config.DEBUG_LOGGING:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º getLogger, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å uvicorn --reload
    logger = logging.getLogger(__name__)
    if not logger.handlers:
        logger.setLevel(logging.INFO)
        # –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        for handler in logger.handlers[:]:
            logger.removeHandler(handler)
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞
        file_handler = logging.FileHandler(config.LOG_FILE, mode='a', encoding='utf-8')
        file_handler.setFormatter(logging.Formatter('%(asctime)s - %(message)s'))
        logger.addHandler(file_handler)

        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
        console_handler = logging.StreamHandler()
        console_handler.setFormatter(logging.Formatter('%(message)s')) # –§–æ—Ä–º–∞—Ç –ø–æ–∫–æ—Ä–æ—á–µ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        logger.addHandler(console_handler)
else:
    # –ï—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º "–ø—É—Å—Ç—ã—à–∫—É", —á—Ç–æ–±—ã –∫–æ–¥ –Ω–µ –ø–∞–¥–∞–ª
    class DummyLogger:
        def info(self, msg, *args, **kwargs): pass
    logger = DummyLogger()

# --- –ù–û–í–´–ô –ë–õ–û–ö: –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–†–û–°–û–í –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò ---
QUERY_LOG_FILE = config.QUERY_LOG_FILE

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –≤–∏–¥–µ JSON
query_logger = logging.getLogger('user_queries')
query_logger.setLevel(logging.INFO)

# –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
query_logger.propagate = False

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
if not query_logger.handlers:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º mode='a' –¥–ª—è –¥–æ–∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª
    query_handler = logging.FileHandler(QUERY_LOG_FILE, mode='a', encoding='utf-8')
    # –§–æ—Ä–º–∞—Ç—Ç–µ—Ä –≤—ã–≤–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ, —Ç.–∫. –º—ã –ø–µ—Ä–µ–¥–∞–µ–º –≥–æ—Ç–æ–≤—É—é JSON-—Å—Ç—Ä–æ–∫—É
    query_handler.setFormatter(logging.Formatter('%(message)s'))
    query_logger.addHandler(query_handler)
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
# --- –ö–û–ù–ï–¶ –°–ï–ö–¶–ò–ò –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ---


class SearchMode(str, Enum):
    mixed = "mixed"
    summary = "summary"
    text = "text"

app = FastAPI(title="CYOA Semantic Search API v5 (User Query Logging)")


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
origins = [
    "https://cyoa.cafe",      # –ê–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞
    "http://localhost:5173", # –ê–¥—Ä–µ—Å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ React (–ø–æ—Ä—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –¥—Ä—É–≥–∏–º)
    "http://127.0.0.1:5173",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"], # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã (GET, POST –∏ —Ç.–¥.)
    allow_headers=["*"], # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ    
faiss_index = None
chunk_map = {}

@app.on_event("startup")
def load_data():
    global faiss_index, chunk_map
    print("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–¥–µ–∫—Å–∞ –∏ –∫–∞—Ä—Ç—ã...")
    if os.path.exists(config.INDEX_FILE) and os.path.exists(config.MAPPING_FILE):
        faiss_index = faiss.read_index(config.INDEX_FILE)
        with open(config.MAPPING_FILE, 'r', encoding='utf-8') as f:
            chunk_map = {int(k): v for k, v in json.load(f).items()}
        print(f"–ò–Ω–¥–µ–∫—Å –∑–∞–≥—Ä—É–∂–µ–Ω: {faiss_index.ntotal} –≤–µ–∫—Ç–æ—Ä–æ–≤.")
    else:
        print("WARN: –§–∞–π–ª—ã –∏–Ω–¥–µ–∫—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∏—Å–∫ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")

# --- –ù–û–í–´–ô –ë–õ–û–ö: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ë–î —á–µ—Ä–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ---
def get_db_connection():
    """
    FastAPI –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î.
    –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ –ø–æ—Å–ª–µ.
    """
    connection = sqlite3.connect(config.DB_FILE)
    try:
        yield connection
    finally:
        connection.close()
# --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

@app.get("/api/semantic-search")
async def search_games(
    q: str = Query(..., min_length=2),
    mode: SearchMode = Query(SearchMode.mixed, description="–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: –ø–æ —Ç–µ–∫—Å—Ç—É, –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ —Å–º–µ—à–∞–Ω–Ω—ã–π"),
    k: int = 200,
    threshold: float = 0.40, 
    conn: sqlite3.Connection = Depends(get_db_connection) # <--- –ò–ù–™–ï–ö–¶–ò–Ø –ó–ê–í–ò–°–ò–ú–û–°–¢–ò
):
    if not faiss_index or not chunk_map:
        raise HTTPException(status_code=503, detail="–ò–Ω–¥–µ–∫—Å –Ω–µ –≥–æ—Ç–æ–≤.")

    logger.info(f"\n{'='*25} –ù–û–í–´–ô –ü–û–ò–°–ö–û–í–´–ô –ó–ê–ü–†–û–° {'='*25}")
    logger.info(f"Query: '{q}' | Mode: {mode} | k: {k} | threshold: {threshold}")
    
    try:
        # 1. –≠–º–±–µ–¥–¥–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞
        q_emb = genai.embed_content(
            model=f"models/{config.EMBEDDING_MODEL_NAME}",
            content=q,
            task_type="RETRIEVAL_QUERY",
            output_dimensionality=config.OUTPUT_DIMENSION
        )['embedding']
        q_vec = np.array([q_emb]).astype('float32')
        faiss.normalize_L2(q_vec)

        # 2. –§–∞–∑–∞ 1: Retrieval - –ü–æ–∏—Å–∫ K –±–ª–∏–∂–∞–π—à–∏—Ö –ß–ê–ù–ö–û–í
        D, I = faiss_index.search(q_vec, k)
        
        indices = I[0]
        scores = D[0]
        logger.info(f"[–§–∞–∑–∞ 1] –ü–æ–∏—Å–∫ –≤ Faiss. –ù–∞–π–¥–µ–Ω–æ {len(indices)} –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —á–∞–Ω–∫–æ–≤-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.")

        # 3. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –∏–≥—Ä–∞–º
        game_data = defaultdict(lambda: {"summary_chunks": [], "text_chunks": []})

        for idx, raw_score in zip(indices, scores):
            if idx == -1 or raw_score < threshold: continue
            
            chunk_info = chunk_map.get(int(idx))
            if not chunk_info: continue

            game_id = chunk_info['game_id']
            chunk_type = chunk_info.get('type', 'text')

            if mode == SearchMode.summary and chunk_type != 'summary': continue
            if mode == SearchMode.text and chunk_type != 'text': continue
            
            chunk_details = {
                "score": float(raw_score),
                "snippet": chunk_info.get('text_snippet', 'N/A')
            }

            if chunk_type == 'summary':
                game_data[game_id]["summary_chunks"].append(chunk_details)
            else:
                game_data[game_id]["text_chunks"].append(chunk_details)

        if not game_data:
            logger.info("–ü–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω –Ω–∏ –æ–¥–Ω–∏–º —á–∞–Ω–∫–æ–º. –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç.")
            return {"results": [], "mode_used": mode}
        
        logger.info(f"\n--- [–§–∞–∑–∞ 2] –ê–≥—Ä–µ–≥–∞—Ü–∏—è —á–∞–Ω–∫–æ–≤ –ø–æ {len(game_data)} –∏–≥—Ä–∞–º ---")
        for game_id, data in game_data.items():
            logger.info(f"–ò–≥—Ä–∞ ID: {game_id}")
            for chunk in data['summary_chunks']:
                logger.info(f"  [SUMMARY] Score: {chunk['score']:.4f} | Snippet: {chunk['snippet']}")
            for chunk in data['text_chunks']:
                logger.info(f"  [TEXT]    Score: {chunk['score']:.4f} | Snippet: {chunk['snippet']}")

        # 4. –§–∞–∑–∞ 2: Re-ranking - –ü—Ä–∏–º–µ–Ω—è–µ–º "–ó–æ–ª–æ—Ç—É—é —Ñ–æ—Ä–º—É–ª—É"
        logger.info("\n--- [–§–∞–∑–∞ 3] –ü–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç '–í–æ–ª—à–µ–±–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã' ---")
        final_game_scores = {}

        for game_id, data in game_data.items():
            summary_scores = [c['score'] for c in data['summary_chunks']]
            text_scores = [c['score'] for c in data['text_chunks']]
            
            summary_score = max(summary_scores or [0])
            
            text_score = 0
            sorted_text_scores = sorted(text_scores, reverse=True)
            for i, score in enumerate(sorted_text_scores):
                text_score += score * (DECAY_FACTOR ** i)
            
            normalizing_divisor = 5.0 
            normalized_text_score = math.log1p(text_score) / normalizing_divisor if text_score > 0 else 0

            final_score = (summary_score * SUMMARY_WEIGHT) + (normalized_text_score * TEXT_WEIGHT)
            
            final_game_scores[game_id] = {
                "score": final_score,
                "match_type": "summary" if summary_score > 0 else "text"
            }
            
            log_msg = (
                f"–†–∞—Å—á–µ—Ç –¥–ª—è –∏–≥—Ä—ã ID: {game_id}\n"
                f"  - Summary Scores: {[f'{s:.4f}' for s in summary_scores]}\n"
                f"  - -> Max Summary Score (A): {summary_score:.4f}\n"
                f"  - Text Scores (sorted): {[f'{s:.4f}' for s in sorted_text_scores]}\n"
                f"  - -> Raw Text Score (decayed sum): {text_score:.4f}\n"
                f"  - -> Normalized Text Score (B): {normalized_text_score:.4f}\n"
                f"  >>> –ò–¢–û–ì–û–í–ê–Ø –§–û–†–ú–£–õ–ê: (A * {config.SUMMARY_WEIGHT}) + (B * {config.TEXT_WEIGHT})\n"
                f"  >>> –†–ï–ó–£–õ–¨–¢–ê–¢: ({summary_score:.4f} * {config.SUMMARY_WEIGHT}) + ({normalized_text_score:.4f} * {config.TEXT_WEIGHT}) = {final_score:.4f}"
            )
            logger.info(log_msg)
            
        # 5. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –≤—ã–±–æ—Ä —Ç–æ–ø-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        sorted_games = sorted(final_game_scores.items(), key=lambda item: item[1]["score"], reverse=True)
        top_games = sorted_games[:20]
        top_game_ids = [g_id for g_id, data in top_games]

        if not top_game_ids:
            return {"results": [], "mode_used": mode}
        
        logger.info("\n--- [–§–∞–∑–∞ 4] –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–ø-20 ---")
        for i, (game_id, score_data) in enumerate(top_games):
             logger.info(f"  #{i+1}: ID={game_id}, Final Score={score_data['score']:.4f}")

        # 6. –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        cursor = conn.cursor()
        placeholders = ','.join('?' * len(top_game_ids))
        sql = f"SELECT pocketbase_id, title, summary, original_url FROM games WHERE pocketbase_id IN ({placeholders})"
        cursor.execute(sql, top_game_ids)
        rows = cursor.fetchall()

        game_meta_map = {row[0]: (row[1], row[2]) for row in rows}
        
        results = []
        for game_id, score_data in top_games:
            meta = game_meta_map.get(game_id)
            if meta:
                title, summary, original_url = meta
                summary_snippet = (summary[:200] + "...") if summary else ""
                
                display_score = min(int(score_data["score"] * 100), 100)

                results.append({
                    "id": game_id,
                    "title": title,
                    "url": original_url or f"{config.BASE_GAME_URL}{game_id}",
                    "score": display_score,
                    "match_type": score_data["match_type"],
                    "snippet": summary_snippet
                })
        
        # --- –ù–û–í–´–ô –ë–õ–û–ö: –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ---
        try:
            log_entry = {
                "timestamp": datetime.now().isoformat(),
                "query": q,
                "mode": mode.value,
                "results_count": len(results),
                "top_results": [
                    {"id": r["id"], "title": r["title"], "score": r["score"]} 
                    for r in results[:3]
                ]
            }
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JSON –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ª–æ–≥
            query_logger.info(json.dumps(log_entry, ensure_ascii=False))
        except Exception as log_e:
            # –ù–µ –ª–æ–º–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ø–∞–ª–æ.
            print(f"ERROR: Could not write user query to log: {log_e}")
        # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
        
        logger.info(f"{'='*28} –ö–û–ù–ï–¶ –ó–ê–ü–†–û–°–ê {'='*28}\n")
        return {"results": results, "mode_used": mode}

    except Exception as e:
        logger.info(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–û–ò–°–ö–ê: {e}")
        # --- –ù–û–í–´–ô –ë–õ–û–ö: –õ–æ–≥–∏—Ä—É–µ–º —Ç–∞–∫–∂–µ –∏ –æ—à–∏–±–∫—É –≤ —Ñ–∞–π–ª –∑–∞–ø—Ä–æ—Å–æ–≤ ---
        try:
            log_entry = {
                "timestamp": datetime.now().isoformat(),
                "query": q,
                "mode": mode.value,
                "error": str(e)
            }
            query_logger.info(json.dumps(log_entry, ensure_ascii=False))
        except Exception as log_e:
             print(f"ERROR: Could not write user query error to log: {log_e}")
        # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---
        raise HTTPException(status_code=500, detail=str(e))

# --- –°—Ç–∞—Ç–∏–∫–∞ –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–æ—É—Ç—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
app.mount("/static", StaticFiles(directory="static"), name="static")

@app.get("/")
async def read_root():
    return FileResponse("static/index.html")

@app.get("/stats")
async def get_stats(conn: sqlite3.Connection = Depends(get_db_connection)):
    cur = conn.cursor()
    total = cur.execute("SELECT COUNT(*) FROM games").fetchone()[0]
    with_text = cur.execute("SELECT COUNT(*) FROM games WHERE full_text IS NOT NULL AND full_text != ''").fetchone()[0]
    with_summary = cur.execute("SELECT COUNT(*) FROM games WHERE summary IS NOT NULL AND summary != ''").fetchone()[0]
    indexed = cur.execute("SELECT COUNT(*) FROM games WHERE last_indexed_at IS NOT NULL").fetchone()[0]
    return {"total": total, "with_text": with_text, "with_summary": with_summary, "indexed": indexed}

@app.get("/games", response_model=List[Dict[str, Any]])
async def get_all_games(conn: sqlite3.Connection = Depends(get_db_connection)):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏."""
    try:
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        cursor.execute("""
            SELECT 
                title, 
                summary, 
                last_indexed_at 
            FROM games 
            ORDER BY title ASC
        """)
        rows = cursor.fetchall()

        games_list = []
        for row in rows:
            games_list.append({
                "title": row["title"],
                "summary": row["summary"],
                "has_summary": bool(row["summary"]),
                "is_indexed": row["last_indexed_at"] is not None
            })
        
        return games_list

    except Exception as e:
        print(f"Error fetching all games: {e}")
        raise HTTPException(status_code=500, detail="Could not fetch game list from database.")
--- END FILE: main.py ---


--- START FILE: manage.py ---
# manage.py
import os
import subprocess
import sys

# --- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ ---
from sync_with_pocketbase import sync_games
from fetch_game_text import main as fetch_texts
from generate_summary import run_summary_generation
from indexer import main as run_indexer
from clear_database import clear_all_games
from reset_index_status import reset_all_statuses


def print_menu():
    """–í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Å–∏–≤–æ–µ –º–µ–Ω—é –≤ –∫–æ–Ω—Å–æ–ª—å."""
    print("\n" + "="*40)
    print("     –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ CYOA     ")
    print("="*40)
    print("\n--- –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞–π–ø–ª–∞–π–Ω ---")
    print(" 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä—ã —Å PocketBase")
    print(" 2. –ò–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –∏–≥—Ä (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö)")
    print(" 3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è (summaries) –¥–ª—è –∏–≥—Ä —Å —Ç–µ–∫—Å—Ç–æ–º")
    print(" 4. –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ù–û–í–´–ï –∏–≥—Ä—ã (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)")
    print(" 4a. [–î–û–õ–ì–û] –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –í–°–ï –∏–≥—Ä—ã")
    print(" 5. [–í–°–Å –°–†–ê–ó–£] –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω (—à–∞–≥–∏ 1-4)")
    
    print("\n--- –í–µ–±-—Å–µ—Ä–≤–µ—Ä ---")
    print(" 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä API (FastAPI)")

    print("\n--- –£—Ç–∏–ª–∏—Ç—ã –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ---")
    print(" 7. –°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä")
    print(" 8. [–û–ü–ê–°–ù–û] –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∏–≥—Ä—ã)")

    print("\n 0. –í—ã—Ö–æ–¥")
    print("-"*40)


def run_server():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç FastAPI —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é uvicorn."""
    print("\n--- –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ FastAPI ---")
    print("–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://127.0.0.1:8000")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ CTRL+C.")
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º subprocess –¥–ª—è –∑–∞–ø—É—Å–∫–∞ uvicorn, —á—Ç–æ–±—ã –æ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª
        # –≤ —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É.
        subprocess.run([sys.executable, "-m", "uvicorn", "main:app", "--reload"])
    except KeyboardInterrupt:
        print("\n–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    except FileNotFoundError:
        print("\n[–û–®–ò–ë–ö–ê] –ö–æ–º–∞–Ω–¥–∞ 'uvicorn' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ uvicorn —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: pip install uvicorn")


def main():
    """–ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    while True:
        print_menu()
        choice = input("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è: ")

        if choice == '1':
            sync_games()
        elif choice == '2':
            fetch_texts()
        elif choice == '3':
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            run_summary_generation()
        elif choice == '4':
            # –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            run_indexer(full_reindex=False)
        elif choice == '4a':
            # –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
            print("\n--- –ó–∞–ø—É—Å–∫ –ü–û–õ–ù–û–ô –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ ---")
            run_indexer(full_reindex=True)
        elif choice == '5':
            print("\n--- –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ---")
            sync_games()
            print("\n--- –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ ---")
            fetch_texts()
            print("\n--- –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π ---")
            run_summary_generation()
            print("\n--- –§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥: –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ---")
            run_indexer(full_reindex=False)
            print("\n--- –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–µ–Ω! ---")
        elif choice == '6':
            run_server()
        elif choice == '7':
            reset_all_statuses()
        elif choice == '8':
            clear_all_games()
        elif choice == '0':
            print("–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã.")
            break
        else:
            print("\n[!] –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–∑ –º–µ–Ω—é.")
        
        input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è...")


if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    required_files = [
        'sync_with_pocketbase.py', 'fetch_game_text.py', 'generate_summary.py',
        'indexer.py', 'main.py', 'clear_database.py', 'reset_index_status.py'
    ]
    missing_files = [f for f in required_files if not os.path.exists(f)]
    if missing_files:
        print("[–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê] –ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã —Å–∫—Ä–∏–ø—Ç–æ–≤:")
        for f in missing_files:
            print(f" - {f}")
        sys.exit(1)

    main()
--- END FILE: manage.py ---


--- START FILE: process_static_cyoa.py ---
# process_static_cyoa.py
import os
import sqlite3
import json
import requests # –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
from datetime import datetime
from dotenv import load_dotenv
from google.cloud import vision

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
DB_FILE = "games.db"

def recognize_text_from_content(image_content: bytes):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–∏–Ω–∞—Ä–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Google Cloud Vision API
    –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
    """
    try:
        client = vision.ImageAnnotatorClient()
        image = vision.Image(content=image_content)
        
        response = client.document_text_detection(image=image)

        if response.error.message:
            raise Exception(f"–û—à–∏–±–∫–∞ API: {response.error.message}")

        return response.full_text_annotation.text if response.full_text_annotation else ""
    
    except Exception as e:
        print(f"  [!] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏: {e}")
        return None


def process_static_games():
    """
    –ù–∞—Ö–æ–¥–∏—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—á–Ω—ã–µ CYOA –≤ –±–∞–∑–µ, —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ç–µ–∫—Å—Ç 
    —Å –∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    """
    print("–ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA...")
    conn = sqlite3.connect(DB_FILE)
    # –£–¥–æ–±–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä–µ–π
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # –í—ã–±–∏—Ä–∞–µ–º –∏–≥—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∏ —è–≤–ª—è—é—Ç—Å—è —Å—Ç–∞—Ç–∏—á–Ω—ã–º–∏ (–∏–º–µ—é—Ç image_urls)
    cursor.execute("""
        SELECT pocketbase_id, title, image_urls FROM games
        WHERE is_indexed = 0 AND image_urls IS NOT NULL AND image_urls != '[]'
    """)
    games_to_process = cursor.fetchall()

    if not games_to_process:
        print("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
        conn.close()
        return

    print(f"–ù–∞–π–¥–µ–Ω–æ {len(games_to_process)} —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.")

    for game in games_to_process:
        print(f"\n--- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: '{game['title']}' (ID: {game['pocketbase_id']}) ---")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ URL –∏–∑ JSON-—Å—Ç—Ä–æ–∫–∏
        image_urls = json.loads(game['image_urls'])
        all_pages_text = []

        for i, url in enumerate(image_urls, 1):
            print(f"  > –°–∫–∞—á–∏–≤–∞–µ–º –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É {i}/{len(image_urls)}...")
            
            try:
                # –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å
                response = requests.get(url, timeout=30)
                response.raise_for_status() # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω (–∫–æ–¥ 2xx)
                image_bytes = response.content

                # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ç–µ–∫—Å—Ç
                recognized_text = recognize_text_from_content(image_bytes)
                if recognized_text:
                    all_pages_text.append(recognized_text)

            except requests.exceptions.RequestException as e:
                print(f"  [!] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ URL: {url}. –û—à–∏–±–∫–∞: {e}")
                continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        
        if all_pages_text:
            # –°–æ–µ–¥–∏–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
            full_text = "\n\n--- PAGE BREAK ---\n\n".join(all_pages_text)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            current_time_iso = datetime.now().isoformat()
            cursor.execute("""
                UPDATE games
                SET full_text = ?, is_indexed = 1, last_indexed_at = ?
                WHERE pocketbase_id = ?
            """, (full_text, current_time_iso, game['pocketbase_id']))
            conn.commit()
            print(f"  [OK] –¢–µ–∫—Å—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è '{game['title']}'.")
        else:
            print(f"  [!] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–µ–∫—Å—Ç –Ω–∏ –Ω–∞ –æ–¥–Ω–æ–π –∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è '{game['title']}'.")

    conn.close()
    print("\n–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö CYOA –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


if __name__ == "__main__":
    process_static_games()
--- END FILE: process_static_cyoa.py ---


--- START FILE: readme ---
source venv/bin/activate
rm games.index chunk_map.json
 
python indexer.py

 
uvicorn main:app --reload --port 8100


pip install -r requirements.txt

scp -r /home/dw/Documents/Coding/cyoa_embendings/semantic-search-deploy/* root@165.227.118.100:~/semantic-search/



---

# README.md (–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)

# –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ CYOA.cafe

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π Python-–±—ç–∫–µ–Ω–¥ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ (—Å–º—ã—Å–ª–æ–≤–æ–≥–æ) –ø–æ–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É –∏–≥—Ä [CYOA.cafe](https://cyoa.cafe/). –°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–≥—Ä—ã –ø–æ –Ω–µ—á–µ—Ç–∫–∏–º, –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–æ–º–Ω–∏—Ç —Ç–æ—á–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π.

–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –ø–æ–ª–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏–≥—Ä —Å –∏—Ö –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ö–æ—Å—Ç–∏–Ω–≥–æ–≤, —Ä–∞–∑–±–∏–≤–∞—Ç—å –∏—Ö –Ω–∞ –Ω–µ–±–æ–ª—å—à–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã (—á–∞–Ω–∫–∏), –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä—ã (—ç–º–±–µ–¥–¥–∏–Ω–≥–∏) —Å –ø–æ–º–æ—â—å—é Google Gemini API –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —Å –ø–æ–º–æ—â—å—é –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Faiss.

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

*   **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PocketBase:** –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä (–Ω–∞–∑–≤–∞–Ω–∏—è, —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—ã) —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
*   **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫—Ä–∞—É–ª–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤:** –ú–æ—â–Ω—ã–π —Å–∫—Ä–∏–ø—Ç (`fetch_game_text.py`) –Ω–∞—Ö–æ–¥–∏—Ç –∏–≥—Ä—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å, –∞–Ω–∞–ª–∏–∑ —Ç—Ä–∞—Ñ–∏–∫–∞, –∏–Ω—Å–ø–µ–∫—Ü–∏—è JS) –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏–≥—Ä—ã.
*   **–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `gemini-embedding-001` –æ—Ç Google –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –≤–µ–∫—Ç–æ—Ä—ã.
*   **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ (MRL + PQ):**
    1.  **Matryoshka Representation Learning (MRL):** –ó–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –∫–æ—Ä–æ—Ç–∫–∏–µ, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ 256-–º–µ—Ä–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã, —á—Ç–æ –≤ 4 —Ä–∞–∑–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö "–Ω–∞ —Å—Ç–∞—Ä—Ç–µ".
    2.  **Faiss `IndexIVFPQ`:** –í–µ–∫—Ç–æ—Ä—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∂–∏–º–∞—é—Ç—Å—è –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑—É—é—Ç—Å—è. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –∏ —Å–≤–µ—Ä—Ö–±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫.
*   **–ù–∞–¥–µ–∂–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ü—Ä–æ—Ü–µ—Å—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏, –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∏—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.
*   **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:** –ü—Ä–æ—Å—Ç–æ–π UI –Ω–∞ HTML/CSS/JS, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è FastAPI. –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–≥—Ä.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
/
|-- static/                  # –§–∞–π–ª—ã –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (UI)
|   |-- index.html
|   |-- style.css
|   `-- script.js
|
|-- .env                     # –•—Ä–∞–Ω–∏—Ç GOOGLE_API_KEY –∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ PocketBase
|-- create_database.py       # (–û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ) –°–æ–∑–¥–∞–µ—Ç —Å—Ö–µ–º—É –ë–î
|-- sync_with_pocketbase.py  # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä –∏–∑ PocketBase
|-- fetch_game_text.py       # –°–∫–∞—á–∏–≤–∞–µ—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã –∏–≥—Ä —Å –∏—Ö —Å–∞–π—Ç–æ–≤
|-- indexer.py               # –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
|-- reset_index_status.py    # –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –≤—Å–µ—Ö –∏–≥—Ä
|-- games.db                 # –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
|-- main.py                  # FastAPI —Å–µ—Ä–≤–µ—Ä (API –∏ UI)
`-- requirements.txt         # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
```

---
## –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–±–æ—á–∏–π —Ü–∏–∫–ª (Workflow)

### 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º
–ó–∞–±–∏—Ä–∞–µ–º —Å–≤–µ–∂–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (ID, –Ω–∞–∑–≤–∞–Ω–∏–µ, URL –æ—Ä–∏–≥–∏–Ω–∞–ª–∞) –∏–∑ PocketBase –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É.
```bash
python sync_with_pocketbase.py
```

### 2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤
–°–∫—Ä–∏–ø—Ç –Ω–∞—Ö–æ–¥–∏—Ç –∏–≥—Ä—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å –∏—Ö —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–æ–≤. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–∏–π –ø—Ä–æ—Ü–µ—Å—Å.
```bash
python fetch_game_text.py
```

### 3. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è
–°–∫—Ä–∏–ø—Ç –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –Ω–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å.
```bash
python indexer.py
```

### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
–ó–∞–ø—É—Å–∫–∞–µ–º API –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
```bash
uvicorn main:app --reload --port 8100
```
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å `http://127.0.0.1:8100/` –≤ –±—Ä–∞—É–∑–µ—Ä–µ.

### –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–Ω–∞—á–∞—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ)
–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –≤–µ—Å—å –∏–Ω–¥–µ–∫—Å —Å –Ω—É–ª—è.

1.  **–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä** (`Ctrl+C`).
2.  **–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
    ```bash
    python reset_index_status.py
    ```
3.  **–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–Ω–¥–µ–∫—Å–∞:**
    ```bash
    # macOS / Linux:
    rm games.index chunk_map.json
    # Windows:
    del games.index chunk_map.json
    ```
4.  **–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä `python indexer.py`** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ, —á–∏—Å—Ç–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞.

---
## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:
‚úÖ **–ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –°–æ–∑–¥–∞–Ω—ã –∏ —Å–≤—è–∑–∞–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä, –∫—Ä–∞—É–ª–µ—Ä, –∏–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä –∏ API.
‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å PocketBase:** –°–∫—Ä–∏–ø—Ç `sync_with_pocketbase.py` —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä, –≤–∫–ª—é—á–∞—è –∫–ª—é—á–µ–≤—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª (`iframe_url`).
‚úÖ **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:** –°–∫—Ä–∏–ø—Ç `fetch_game_text.py` —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–≥—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç—ã –≤ –±–∞–∑—É.
‚úÖ **–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è:** –°–∫—Ä–∏–ø—Ç `indexer.py` –Ω–∞–¥–µ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ (—Å —É—á–µ—Ç–æ–º –ª–∏–º–∏—Ç–æ–≤ API) –∏ —Å—Ç—Ä–æ–∏—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å Faiss.
‚úÖ **–ë–∞–∑–æ–≤—ã–π UI:** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —Å–ø–∏—Å–æ–∫ –∏–≥—Ä –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–∏—Å–∫.

### –ù–∞ —á—ë–º –º—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å (–∫–ª—é—á–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞):
üî¥ **–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–∏—Å–∫–∞ –∏ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏.** –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞ –Ω–µ–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã:
- **–í—Å–µ–≥–¥–∞ –≤—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å:** –î–∞–∂–µ –¥–ª—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –æ—Ü–µ–Ω–∫–æ–π ~93-94%.
- **–ú–∞–ª—ã–π —Ä–∞–∑–±—Ä–æ—Å –æ—Ü–µ–Ω–æ–∫:** –†–∞–∑–Ω–∏—Ü–∞ –≤ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–º –∏ —Å–ª—É—á–∞–π–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–µ–≥–æ 1-2 –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞.

**–ì–∏–ø–æ—Ç–µ–∑–∞:** –ü—Ä–æ–±–ª–µ–º–∞ –∫—Ä–æ–µ—Ç—Å—è –≤ –∫–∞–ª–∏–±—Ä–æ–≤–∫–µ –æ—Ü–µ–Ω–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏. –¢–µ–∫—É—â–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞ score –∏ –≤–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –æ—Ç—Å–µ—á–µ–Ω–∏—è –≤ `main.py`) –ø–æ–∫–∞ –Ω–µ –¥–∞–ª–∏ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ –≥–ª—É–±–∂–µ ‚Äî –≤ —Å–∞–º–æ–π –ø—Ä–∏—Ä–æ–¥–µ L2-—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ Gemini.

### –ü–ª–∞–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å–µ—Å—Å–∏—é:
1.  **–ì–ª—É–±–æ–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–∏—Å–∫–∞:**
    -   –í—ã–≤–µ—Å—Ç–∏ –≤ –ª–æ–≥ –∏–ª–∏ –≤ API-–æ—Ç–≤–µ—Ç —Å—ã—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è L2-—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (`dist`), –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Faiss, –¥–ª—è —Ö–æ—Ä–æ—à–∏—Ö –∏ –ø–ª–æ—Ö–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω–∏–π.
    -   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –Ω—É–∂–Ω–æ –ª–∏ –Ω–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –º–µ—Ç—Ä–∏–∫—É –≤–º–µ—Å—Ç–æ L2-—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è. Faiss –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **—Å–∫–∞–ª—è—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ (Inner Product)**, –∫–æ—Ç–æ—Ä–æ–µ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ (–∞ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ Gemini –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã). –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–ª—é—á–µ–≤—ã–º —Ä–µ—à–µ–Ω–∏–µ–º.
    
2.  **–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `IndexFlatIP` (—Å–∫–∞–ª—è—Ä–Ω–æ–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ):**
    -   –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `indexer.py` –∏ `main.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `faiss.IndexFlatIP` –≤–º–µ—Å—Ç–æ `faiss.IndexFlatL2`.
    -   –≠—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–µ–∫—Ç–æ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ –∏–Ω–¥–µ–∫—Å (—Ö–æ—Ç—è –æ–Ω–∏ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã).
    -   –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ score —Ç–∞–∫–∂–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è (–¥–ª—è —Å–∫–∞–ª—è—Ä–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —á–µ–º –±–æ–ª—å—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–µ–º –ª—É—á—à–µ).

3.  **–¢—é–Ω–∏–Ω–≥ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (To-Do –∏–∑ –∑–∞–º–µ—Ç–æ–∫):**
    -   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –ª–æ–≥–∏–∫—É –ø–æ–¥—Å—á–µ—Ç–∞ –æ—á–∫–æ–≤. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª—É—á—à–∏–π —á–∞–Ω–∫ –¥–ª—è –∏–≥—Ä—ã, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –æ—á–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ –æ–¥–Ω–æ–π –∏–≥—Ä—ã –∏–ª–∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –≠—Ç–æ –ø–æ–≤—ã—Å–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∏–≥—Ä, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ç–µ–º–∞ –∑–∞–ø—Ä–æ—Å–∞ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ.














"Workflow –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏"
–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å —á–µ—Ç–∫–∏–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:
–û—Å—Ç–∞–Ω–æ–≤–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä (Ctrl+C –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω uvicorn).
–°–±—Ä–æ—Å—å —Å—Ç–∞—Ç—É—Å—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

python reset_index_status.py
(–ù–∞–∂–º–∏ y –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
–£–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–Ω–¥–µ–∫—Å–∞:

rm games.index chunk_map.json  # –∏–ª–∏ `del` –≤ Windows

–ó–∞–ø—É—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä:

python indexer.py

–û–Ω –Ω–∞–π–¥–µ—Ç –≤—Å–µ –∏–≥—Ä—ã —Å —Ç–µ–∫—Å—Ç–æ–º (–ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã —Å–±—Ä–æ—Å–∏–ª–∏ –∏—Ö —Å—Ç–∞—Ç—É—Å), —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–ª—è –Ω–∏—Ö —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏ —Å–æ–∑–¥–∞—Å—Ç —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤—ã–µ games.index –∏ chunk_map.json.
–ó–∞–ø—É—Å—Ç–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä:

uvicorn main:app --reload

–°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç —Å–≤–µ–∂–∏–µ —Ñ–∞–π–ª—ã –∏–Ω–¥–µ–∫—Å–∞, –∏ —Ç–≤–æ–π –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Å–∞–º—ã—Ö –ø–æ–ª–Ω—ã—Ö –∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
–≠—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —Ç—ã —Ö–æ—á–µ—à—å –±—ã—Ç—å –Ω–∞ 100% —É–≤–µ—Ä–µ–Ω, —á—Ç–æ –ø–æ–∏—Å–∫–æ–≤–∞—è –±–∞–∑–∞ –≤ –∏–¥–µ–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.










## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Python-—Å–µ—Ä–≤–∏—Å–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (Droplet Cheatsheet)

–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å Python-–±—ç–∫–µ–Ω–¥–æ–º –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∫–∞–∫ —Ñ–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å.

### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤

–í—Å–µ —Ñ–∞–π–ª—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ Python-—Å–µ—Ä–≤–∏—Å—É (–∫–æ–¥, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∏—Å–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å), –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
```bash
/root/semantic-search/
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º (`systemd`)

–°–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –ø–æ–º–æ—â—å—é `systemd`. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ SSH (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Tabby).

#### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞

–°–∞–º–∞—è –≤–∞–∂–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–∏—Å, –∏ –≤—ã–≤–æ–¥–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤.

```bash
systemctl status semantic-search.service
```

-   ‚úÖ **–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `active (running)` –∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞.
-   ‚ùå **–ü–ª–æ—Ö–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `failed` –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏.

#### –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å

–ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ñ–∞–π–ª–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫.

```bash
systemctl stop semantic-search.service
```

#### –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å

```bash
systemctl start semantic-search.service
```

#### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å

–ü—Ä–∏–º–µ–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞. –≠—Ç–æ —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.

```bash
systemctl restart semantic-search.service
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

–ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ—à–∏–±–∫–∞–º–∏, –ª–æ–≥–∏ ‚Äî —Ç–≤–æ–π –ª—É—á—à–∏–π –¥—Ä—É–≥.

#### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ –∏ –≤—ã–π—Ç–∏
journalctl -u semantic-search.service -n 100
```

#### –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏. –û—Ç–∫—Ä–æ–π –≤—Ç–æ—Ä–æ–µ –æ–∫–Ω–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∏ –∑–∞–ø—É—Å—Ç–∏ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –¢—ã –±—É–¥–µ—à—å –≤–∏–¥–µ—Ç—å –≤—Å–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —Å–µ—Ä–≤–∏—Å–æ–º, –≤ –ø—Ä—è–º–æ–º —ç—Ñ–∏—Ä–µ.

```bash
journalctl -u semantic-search.service -f
```
(–î–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞–∂–º–∏ `Ctrl + C`)

---

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ (Workflow)

–î–æ–ø—É—Å—Ç–∏–º, —Ç—ã —É–ª—É—á—à–∏–ª `main.py` –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª –∏ —Ö–æ—á–µ—à—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

1.  **–ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É** –ø–æ SSH (—á–µ—Ä–µ–∑ Tabby).

2.  **–û—Å—Ç–∞–Ω–æ–≤–∏ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–∏—Å**, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª—ã:
    ```bash
    systemctl stop semantic-search.service
    ```

3.  **–ó–∞–≥—Ä—É–∑–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** —Å –ø–æ–º–æ—â—å—é SFTP –≤ Tabby. –ü–µ—Ä–µ—Ç–∞—â–∏ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫—É `/root/semantic-search/`, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—è —Å—Ç–∞—Ä—ã–µ.

4.  **(–ï—Å–ª–∏ –Ω—É–∂–Ω–æ) –û–±–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ï—Å–ª–∏ —Ç—ã –º–µ–Ω—è–ª `requirements.txt`, –Ω–µ –∑–∞–±—É–¥—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã:
    ```bash
    # –ü–µ—Ä–µ–π–¥–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
    cd /root/semantic-search/
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    source venv/bin/activate
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    pip install -r requirements.txt
    ```

5.  **–ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å —Å–Ω–æ–≤–∞:**
    ```bash
    systemctl start semantic-search.service
    ```

6.  **–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å**, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å –±–µ–∑ –æ—à–∏–±–æ–∫:
    ```bash
    systemctl status semantic-search.service
    ```

–≠—Ç–∞ —à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ–º–æ–∂–µ—Ç –±—ã—Å—Ç—Ä–æ —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –Ω–µ –∑–∞—Ö–æ–¥–∏–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤.
--- END FILE: readme ---


--- START FILE: requirements.txt ---
annotated-types==0.7.0
anyio==4.11.0
attrs==25.4.0
beautifulsoup4==4.14.2
cachetools==6.2.1
certifi==2025.10.5
chardet==5.2.0
charset-normalizer==3.4.4
click==8.3.0
distro==1.9.0
docstring_parser==0.17.0
docutils==0.22.2
faiss-cpu==1.12.0
fastapi==0.119.0
flit==3.12.0
flit_core==3.12.0
gitignore_parser==0.1.13
google-ai-generativelanguage==0.6.15
google-api-core==2.26.0
google-api-python-client==2.184.0
google-auth==2.41.1
google-auth-httplib2==0.2.0
google-cloud-aiplatform==1.121.0
google-cloud-bigquery==3.38.0
google-cloud-core==2.4.3
google-cloud-resource-manager==1.14.2
google-cloud-storage==2.19.0
google-cloud-vision==3.10.2
google-crc32c==1.7.1
google-genai==1.45.0
google-generativeai==0.8.5
google-resumable-media==2.7.2
googleapis-common-protos==1.70.0
gpt-repository-loader==0.10.0
grpc-google-iam-v1==0.14.3
grpcio==1.75.1
grpcio-status==1.71.2
h11==0.16.0
httpcore==1.0.9
httplib2==0.31.0
httptools==0.7.1
httpx==0.28.1
idna==3.11
jiter==0.11.1
numpy==2.3.3
openai==2.4.0
outcome==1.3.0.post0
packaging==25.0
pathspec==0.12.1
pocketbase==0.15.0
pocketbase-client==0.2.3
proto-plus==1.26.1
protobuf==5.29.5
pyasn1==0.6.1
pyasn1_modules==0.4.2
pydantic==2.12.2
pydantic_core==2.41.4
pyparsing==3.2.5
pyperclip==1.11.0
PySocks==1.7.1
python-dateutil==2.9.0.post0
python-dotenv==1.1.1
PyYAML==6.0.3
regex==2025.9.18
requests==2.32.5
rsa==4.9.1
selenium==4.36.0
shapely==2.1.2
six==1.17.0
sniffio==1.3.1
sortedcontainers==2.4.0
soupsieve==2.8
starlette==0.48.0
tabulate==0.9.0
tenacity==9.1.2
tiktoken==0.12.0
token-count==0.2.1
tomli_w==1.2.0
tqdm==4.67.1
trio==0.31.0
trio-websocket==0.12.2
typing-inspection==0.4.2
typing_extensions==4.15.0
uritemplate==4.2.0
urllib3==2.5.0
uvicorn==0.37.0
uvloop==0.21.0
watchfiles==1.1.1
webdriver-manager==4.0.2
websocket-client==1.9.0
websockets==15.0.1
wsproto==1.2.0

--- END FILE: requirements.txt ---


--- START FILE: reset_index_status.py ---
# reset_index_status.py
import sqlite3
import os
import config

def reset_all_statuses():
    """
    –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–ª—è –í–°–ï–• –∏–≥—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö,
    —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è last_indexed_at –≤ NULL.
    –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç indexer.py –ø–µ—Ä–µ–æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Ö –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ.
    """
    if not os.path.exists(config.DB_FILE):
        print(f"–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö '{config.DB_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–µ—á–µ–≥–æ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å.")
        return

    try:
        conn = sqlite3.connect(config.DB_FILE)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
        cursor.execute("SELECT COUNT(*) FROM games WHERE last_indexed_at IS NOT NULL")
        count_before = cursor.fetchone()[0]

        if count_before == 0:
            print("–í—Å–µ –∏–≥—Ä—ã –≤ –±–∞–∑–µ —É–∂–µ –≥–æ—Ç–æ–≤—ã –∫ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ (—Å—Ç–∞—Ç—É—Å —Å–±—Ä–æ—à–µ–Ω).")
            conn.close()
            return
            
        print(f"–ù–∞–π–¥–µ–Ω–æ {count_before} –∏–≥—Ä —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ–± –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.")
        confirm = input(f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¥–ª—è —ç—Ç–∏—Ö –∏–≥—Ä? (y/n): ")
        
        if confirm.lower() == 'y':
            print("–°–±—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏...")
            # –ì–ª–∞–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å last_indexed_at –≤ NULL –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
            cursor.execute("UPDATE games SET last_indexed_at = NULL")
            
            conn.commit()
            print(f"–°—Ç–∞—Ç—É—Å –¥–ª—è {cursor.rowcount} –∏–≥—Ä –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω.")
            print("–¢–µ–ø–µ—Ä—å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ `indexer.py` –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Ö –≤—Å–µ –∑–∞–Ω–æ–≤–æ.")
        else:
            print("–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

        conn.close()
        
    except Exception as e:
        print(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    reset_all_statuses()
--- END FILE: reset_index_status.py ---


--- START FILE: summary_prompt.txt ---
You are an expert cataloger of Choose Your Own Adventure (CYOA), interactive fiction, and visual novel games.
Your task is to analyze the provided raw text of a game and generate a comprehensive, structured summary designed to optimize semantic search and tagging.

The raw text may include code snippets, UI elements, or fragmented narratives. Ignore technical formatting and focus on the content.

Generate a summary that fits within 1500 words. Do not use Markdown formatting (no bolding, no lists with asterisks). Just plain text paragraphs.

Structure the summary to include the following information intuitively:

1.  **Genre & Setting:** clearly define the genre (e.g., High Fantasy, Cyberpunk, Slice of Life, Horror) and the world the game takes place in.
2.  **Premise & Protagonist:** Who is the player character? What is their initial goal or driving conflict?
3.  **Gameplay & Mechanics:** Is it text-heavy? Are there stat management, inventory systems, combat, or relationship tracking?
4.  **Tone & Themes:** Describe the atmosphere (e.g., dark, humorous, cozy, intense) and main themes (e.g., survival, romance, power, corruption).
5.  **Content & Tags:** Explicitly mention key elements users might search for. Examples: gender-selectable protagonist, character customization, magic systems, specific fetishes or NSFW content (if apparent), LGBTQ+ themes, multiple endings.

End the summary with a paragraph listing comma-separated keywords and tags derived from the analysis.

Input Game Text:
--- END FILE: summary_prompt.txt ---


--- START FILE: sync_with_pocketbase.py ---
# sync_with_pocketbase.py (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
import os
import sqlite3
import json
from dotenv import load_dotenv
# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–º–ø–æ—Ä—Ç, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å —Ç–≤–æ–µ–π –≤–µ—Ä—Å–∏–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ ---
# –ú—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å 'Client' –∏ –¥–∞–µ–º –µ–º—É –ø—Å–µ–≤–¥–æ–Ω–∏–º 'PocketBase' –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è.
from pocketbase.client import Client as PocketBase
# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
load_dotenv()
DB_FILE = "games.db"
POCKETBASE_URL = "https://cyoa.cafe"
ADMIN_EMAIL = os.getenv('EMAIL')
ADMIN_PASSWORD = os.getenv('PASSWORD')

def sync_games():
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∏–≥—Ä—ã –∏–∑ PocketBase —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite."""
    print("–ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å PocketBase...")

    try:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê
        client = PocketBase(POCKETBASE_URL)
        client.admins.auth_with_password(ADMIN_EMAIL, ADMIN_PASSWORD)
        print("–£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ PocketBase.")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ PocketBase: {e}")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    try:
        all_pb_games = client.collection("games").get_full_list(batch=200, query_params={"sort": "-created"})
        print(f"–ò–∑ PocketBase –ø–æ–ª—É—á–µ–Ω–æ {len(all_pb_games)} –∏–≥—Ä.")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä –∏–∑ PocketBase: {e}")
        conn.close()
        return

    added_count = 0
    updated_count = 0
    for game in all_pb_games:
        try:
            # –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä
            cursor.execute(
                "INSERT OR IGNORE INTO games (pocketbase_id, title) VALUES (?, ?)",
                (game.id, game.title)
            )
            if cursor.rowcount > 0:
                added_count += 1

            # –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
            # –¢–∏–ø 1: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è CYOA (—Å—Å—ã–ª–∫–∞)
            if game.img_or_link == 'link' and game.iframe_url:
                cursor.execute(
                    "UPDATE games SET original_url = ? WHERE pocketbase_id = ?",
                    (game.iframe_url, game.id)
                )
                if cursor.rowcount > 0: updated_count += 1
            
            # –¢–∏–ø 2: –°—Ç–∞—Ç–∏—á–Ω–∞—è CYOA (–∫–∞—Ä—Ç–∏–Ω–∫–∏)
            elif game.img_or_link == 'img' and game.cyoa_pages:
                image_urls = []
                # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–µ URL –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –ø–æ—Ä—è–¥–æ–∫
                for filename in game.cyoa_pages:
                    url = f"{POCKETBASE_URL}/api/files/{game.collection_id}/{game.id}/{filename}"
                    image_urls.append(url)
                
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ JSON-—Å—Ç—Ä–æ–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                image_urls_json = json.dumps(image_urls)
                cursor.execute(
                    "UPDATE games SET image_urls = ? WHERE pocketbase_id = ?",
                    (image_urls_json, game.id)
                )
                if cursor.rowcount > 0: updated_count += 1

        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–≥—Ä—É {game.id} ({game.title}): {e}")

    conn.commit()
    conn.close()
    
    print("-" * 20)
    print("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    print(f"–î–æ–±–∞–≤–ª–µ–Ω–æ {added_count} –Ω–æ–≤—ã—Ö –∏–≥—Ä.")
    print(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∑–∞–ø–∏—Å–µ–π —Å URL-–∞–º–∏.")
    print("–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏!")

if __name__ == "__main__":
    sync_games()
--- END FILE: sync_with_pocketbase.py ---


--- START FILE: static/index.html ---
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYOA AI Search v3</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="main-container">
        <h1>CYOA Semantic Search (Text + AI Summary)</h1>

        <div class="container" id="stats-container">
            Loading stats...
        </div>

        <div class="container search-container">
            <form id="search-form">
                <!-- ... –≤–∞—à–∞ —Ñ–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->
                <div class="search-bar">
                    <input type="text" id="search-query" placeholder="Describe game: e.g., 'isekai rpg with crafting', '#horror school setting'" required>
                    <button type="submit">Search</button>
                </div>
                <div class="search-options">
                    <label>Search Mode:</label>
                    <label class="radio-label">
                        <input type="radio" name="search-mode" value="mixed" checked> Mixed (Smart)
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="search-mode" value="summary"> Summary Only (Tags/Genre)
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="search-mode" value="text"> Raw Text Only
                    </label>
                </div>
            </form>
        </div>

        <div class="container results-container">
            <div id="search-results"></div>
        </div>

        <!-- ======== –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –°–ü–ò–°–ö–ê –ò–ì–† ======== -->
        <div class="container" id="all-games-container">
            <h2>All Games in Database</h2>
            <div id="all-games-list">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–≥—Ä -->
                <p>Loading game list...</p>
            </div>
        </div>
        <!-- ============================================= -->

    </div>

    <script src="/static/script.js"></script>
</body>
</html>
--- END FILE: static/index.html ---


--- START FILE: static/script.js ---
document.addEventListener('DOMContentLoaded', () => {
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-query');
    const resultsDiv = document.getElementById('search-results');
    const statsDiv = document.getElementById('stats-container');

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    fetch('/stats').then(r => r.json()).then(data => {
        statsDiv.innerHTML = `
            Total: <b>${data.total}</b> | 
            With Text: <b>${data.with_text}</b> | 
            With AI Summary: <b style="color:#4caf50">${data.with_summary}</b> | 
            Indexed: <b>${data.indexed}</b>
        `;
    });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        const mode = document.querySelector('input[name="search-mode"]:checked').value;

        if (query.length < 2) return;
        resultsDiv.innerHTML = '<p>Searching analyzing semantics...</p>';

        try {
            const res = await fetch(`/api/semantic-search?q=${encodeURIComponent(query)}&mode=${mode}`);
            const data = await res.json();

            if (data.results.length === 0) {
                resultsDiv.innerHTML = `<p>No results found in <b>${mode}</b> mode.</p>`;
                return;
            }

            const html = data.results.map(game => {
                const snippetHtml = game.snippet ? `<div class="result-snippet">AI Summary: "${game.snippet}"</div>` : '';
                const matchClass = game.match_type === 'summary' ? 'summary' : 'text';
                const matchLabel = game.match_type === 'summary' ? 'AI Match' : 'Text Match';

                return `
                    <div class="result-item">
                        <div class="result-header">
                            <a href="${game.url}" target="_blank" class="result-title">${game.title}</a>
                            <div class="result-meta">
                                <span class="badge ${matchClass}">${matchLabel}</span>
                                <span class="score">${game.score}%</span>
                            </div>
                        </div>
                        ${snippetHtml}
                    </div>
                `;
            }).join('');

            resultsDiv.innerHTML = `<p style="color:#888; margin-bottom:10px">Results using <b>${data.mode_used}</b> mode:</p>` + html;
        } catch (err) {
            resultsDiv.innerHTML = `<p style="color:red">Error: ${err.message}</p>`;
        }
    });

    // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∏–≥—Ä ---
    async function loadAllGames() {
        const gamesListDiv = document.getElementById('all-games-list');
        try {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç /games –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            const response = await fetch('/games'); 
            const games = await response.json();

            if (games.length === 0) {
                gamesListDiv.innerHTML = '<p>No games found in the database.</p>';
                return;
            }

            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–∞–∂–¥–æ–π –∏–≥—Ä—ã
            const gamesHtml = games.map((game, index) => {
                const indexedStatus = game.is_indexed
                    ? '<span class="status-indicator indexed">Indexed</span>'
                    : '<span class="status-indicator not-indexed">Not Indexed</span>';
                
                // –ï—Å–ª–∏ summary –µ—Å—Ç—å - —Å–æ–∑–¥–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ –º–µ—Ç–∫—É
                const summaryStatus = game.has_summary
                    ? `<span class="summary-toggle" data-target="summary-${index}">Summary</span>`
                    : '<span class="status-indicator no-summary">No Summary</span>';

                // –ï—Å–ª–∏ summary –µ—Å—Ç—å - —Å–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π div —Å –µ–≥–æ —Ç–µ–∫—Å—Ç–æ–º
                const summaryContent = game.has_summary
                    ? `<div class="summary-content" id="summary-${index}">${game.summary.replace(/\n/g, '<br>')}</div>`
                    : '';

                return `
                    <div class="game-item-list">
                        <div class="game-header-list">
                            <span class="game-title-list">${game.title}</span>
                            <div class="game-meta-list">
                                ${indexedStatus}
                                ${summaryStatus}
                            </div>
                        </div>
                        ${summaryContent}
                    </div>
                `;
            }).join('');

            gamesListDiv.innerHTML = gamesHtml;

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ "Summary"
            document.querySelectorAll('.summary-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const targetId = toggle.getAttribute('data-target');
                    const summaryContent = document.getElementById(targetId);
                    if (summaryContent) {
                        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å 'visible' –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è
                        summaryContent.classList.toggle('visible');
                    }
                });
            });

        } catch (error) {
            gamesListDiv.innerHTML = `<p style="color:red">Error loading game list: ${error.message}</p>`;
        }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadAllGames();
});
--- END FILE: static/script.js ---


--- START FILE: static/style.css ---
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
}

.main-container {
    max-width: 800px;
    margin: auto;
}

h1, h2, h3 {
    color: #ffffff;
    border-bottom: 1px solid #444;
    padding-bottom: 10px;
}

.container {
    background-color: #1e1e1e;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

input[type="text"], textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid #444;
    background-color: #2a2a2a;
    color: #e0e0e0;
    box-sizing: border-box;
}

textarea {
    resize: vertical;
}

button {
    background-color: #3f51b5;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s;
}

button:hover {
    background-color: #303f9f;
}

.status, .results {
    margin-top: 15px;
    padding: 10px;
    border-radius: 4px;
}

.status.success {
    background-color: #2e7d32;
    color: white;
}

.status.error {
    background-color: #c62828;
    color: white;
}

.results ul {
    list-style-type: none;
    padding: 0;
}

.results li {
    background-color: #2a2a2a;
    padding: 10px 15px;
    margin-bottom: 8px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* --- –ù–û–í–´–ï –°–¢–ò–õ–ò --- */

#stats-container {
    text-align: center;
    font-size: 1.1em;
    padding: 15px;
}

#all-games-list {
    max-height: 400px;
    overflow-y: auto;
    padding: 5px 15px; /* –£–º–µ–Ω—å—à–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è —Å–ø–∏—Å–∫–∞ */
}

.result-item a {
    color: #8c9eff;
    text-decoration: none;
    font-weight: bold;
}

.result-item a:hover {
    text-decoration: underline;
}

.result-item span {
    background-color: #3f51b5;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    min-width: 120px;
    text-align: center;
} 
body {
    font-family: sans-serif;
    background: #121212;
    color: #e0e0e0;
    padding: 20px;
}
.main-container { max-width: 900px; margin: auto; }
.container { background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
h1 { color: #fff; text-align: center; }

/* –°—Ç–∏–ª–∏ –ø–æ–∏—Å–∫–∞ */
.search-bar { display: flex; gap: 10px; }
input[type="text"] {
    flex-grow: 1; padding: 12px; border: 1px solid #444;
    background: #2a2a2a; color: white; border-radius: 4px; font-size: 16px;
}
button {
    padding: 10px 20px; background: #3f51b5; color: white;
    border: none; border-radius: 4px; cursor: pointer; font-size: 16px;
}
button:hover { background: #303f9f; }

/* –ù–û–í–û–ï: –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–¥–∏–æ-–∫–Ω–æ–ø–æ–∫ */
.search-options {
    margin-top: 15px; display: flex; gap: 15px; align-items: center; font-size: 0.9em; color: #aaa;
}
.radio-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
.radio-label input { cursor: pointer; }

/* –°—Ç–∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
.result-item {
    background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 6px;
}
.result-header {
    display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;
}
.result-title {
    font-size: 1.2em; color: #8c9eff; text-decoration: none; font-weight: bold;
}
.result-title:hover { text-decoration: underline; }

.result-meta { display: flex; gap: 10px; font-size: 0.8em; }

/* –ë–µ–π–¥–∂–∏ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è */
.badge { padding: 3px 8px; border-radius: 4px; color: white; font-weight: bold; }
.badge.summary { background-color: #2e7d32; } /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–∞–º–º–∞—Ä–∏ */
.badge.text { background-color: #555; }       /* –°–µ—Ä—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞ */
.score { color: #aaa; }

.result-snippet {
    font-size: 0.9em; color: #ccc; font-style: italic; line-height: 1.4;
}


/* ======== –°–¢–ò–õ–ò –î–õ–Ø –°–ü–ò–°–ö–ê –í–°–ï–• –ò–ì–† ======== */
#all-games-container h2 {
    text-align: center;
    margin-top: 0;
    border-bottom: 1px solid #444;
    padding-bottom: 10px;
}

#all-games-list {
    max-height: 500px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
    overflow-y: auto;
    padding-right: 10px; /* –ú–µ—Å—Ç–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
}

/* –≠–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –∏–≥—Ä */
.game-item-list {
    background-color: #2a2a2a;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-radius: 6px;
    border-left: 3px solid #3f51b5; /* –ê–∫—Ü–µ–Ω—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞ */
}

.game-header-list {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.game-title-list {
    font-weight: bold;
    color: #e0e0e0;
}

.game-meta-list {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* –û–±—â–∏–π —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–∫ */
.status-indicator, .summary-toggle {
    font-size: 0.8em;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: bold;
    white-space: nowrap; /* –ó–∞–ø—Ä–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ç–µ–∫—Å—Ç–∞ */
}

/* –°—Ç–∞—Ç—É—Å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ */
.status-indicator.indexed {
    background-color: #2e7d32; /* –ó–µ–ª–µ–Ω—ã–π */
    color: white;
}

.status-indicator.not-indexed {
    background-color: #c62828; /* –ö—Ä–∞—Å–Ω—ã–π */
    color: white;
}

/* –°—Ç–∞—Ç—É—Å summary */
.status-indicator.no-summary {
    background-color: #555; /* –°–µ—Ä—ã–π */
    color: #bbb;
}

/* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ Summary */
.summary-toggle {
    background-color: #3f51b5; /* –°–∏–Ω–∏–π */
    color: white;
    cursor: pointer;
    user-select: none; /* –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ */
    transition: background-color 0.2s;
}

.summary-toggle:hover {
    background-color: #303f9f;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞ summary */
.summary-content {
    display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    margin-top: 12px;
    padding: 10px;
    background-color: #1a1a1a; /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ —Ñ–æ–Ω–∞ */
    border-radius: 4px;
    font-size: 0.9em;
    color: #ccc;
    line-height: 1.5;
    border-top: 1px solid #444;
    word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
}

/* –ö–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π JS –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∞ */
.summary-content.visible {
    display: block;
}
--- END FILE: static/style.css ---
