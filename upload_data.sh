#!/bin/bash

# ==============================================================================
#      –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# ==============================================================================

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ê–¥—Ä–µ—Å —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
SERVER="root@165.227.118.100"
# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å / –≤ –∫–æ–Ω—Ü–µ)
REMOTE_DIR="/root/semantic-search/"
# –°–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
SERVICE_NAME="semantic-search.service"
# –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å
FILES_TO_UPLOAD=(
    "games.db"
    "games.index"
    "chunk_map.json"
)
# -----------------

echo ">>> –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–æ–∫–∞–ª—å–Ω–æ
echo "1/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
for file in "${FILES_TO_UPLOAD[@]}"; do
    if [ ! -f "$file" ]; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª '$file' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–∞."
        exit 1
    fi
done
echo "‚úÖ –í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ."

# 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª—ã
echo "2/5: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–µ—Ä–≤–∏—Å '$SERVICE_NAME' –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh $SERVER "systemctl stop $SERVICE_NAME"
echo "‚úÖ –°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."

# 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø–æ–º–æ—â—å—é scp
echo "3/5: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
for file in "${FILES_TO_UPLOAD[@]}"; do
    echo "    -> –ó–∞–≥—Ä—É–∂–∞—é $file..."
    # scp [–ª–æ–∫–∞–ª—å–Ω—ã–π_—Ñ–∞–π–ª] [–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@—Å–µ—Ä–≤–µ—Ä:—É–¥–∞–ª–µ–Ω–Ω—ã–π_–ø—É—Ç—å]
    scp -q "$file" "${SERVER}:${REMOTE_DIR}"
done
echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã."

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo "4/5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å '$SERVICE_NAME'..."
ssh $SERVER "systemctl restart $SERVICE_NAME"
echo "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞."

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
echo "5/5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥)..."
sleep 3 # –î–∞–µ–º —Å–µ—Ä–≤–∏—Å—É –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—É—Å–∫
ssh $SERVER "systemctl status $SERVICE_NAME --no-pager | tail -n 10"

echo ""
echo "üéâ –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "–ü—Ä–æ–≤–µ—Ä—å –≤—ã–≤–æ–¥ –≤—ã—à–µ: —Å—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'active (running)' (–∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º)."